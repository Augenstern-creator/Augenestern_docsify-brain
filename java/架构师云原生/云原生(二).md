

# 0ã€Yamlæ–‡ä»¶è¯¦æƒ…

Kubernetes æ”¯æŒ Yaml æ ¼å¼ç®¡ç†èµ„æºå¯¹è±¡ã€‚

## 0.1ã€Pod yaml

```yaml
apiVersion: v1			#å¿…é€‰ï¼Œç‰ˆæœ¬å·ï¼Œä¾‹å¦‚v1
kind: Pod				#å¿…é€‰ï¼ŒPod
metadata:				#å¿…é€‰ï¼Œå…ƒæ•°æ®
  name: string			  #å¿…é€‰ï¼ŒPodåç§°
  namespace: string		  #å¿…é€‰ï¼ŒPodæ‰€å±çš„å‘½åç©ºé—´
  labels:				  #è‡ªå®šä¹‰æ ‡ç­¾
    - name: string		    #è‡ªå®šä¹‰æ ‡ç­¾åå­—
  annotations:			    #è‡ªå®šä¹‰æ³¨é‡Šåˆ—è¡¨
    - name: string
spec:					#å¿…é€‰ï¼ŒPodä¸­å®¹å™¨çš„è¯¦ç»†å®šä¹‰
  containers:			  #å¿…é€‰ï¼ŒPodä¸­å®¹å™¨åˆ—è¡¨
  - name: string		    #å¿…é€‰ï¼Œå®¹å™¨åç§°
    image: string		    #å¿…é€‰ï¼Œå®¹å™¨çš„é•œåƒåç§°
    imagePullPolicy: [Always | Never | IfNotPresent]	#è·å–é•œåƒçš„ç­–ç•¥ï¼šAlawysè¡¨ç¤ºæ€»æ˜¯ä¸‹è½½é•œåƒï¼ŒIfnotPresentè¡¨ç¤ºä¼˜å…ˆä½¿ç”¨æœ¬åœ°é•œåƒï¼Œå¦åˆ™ä¸‹è½½é•œåƒï¼ŒNerverè¡¨ç¤ºä»…ä½¿ç”¨æœ¬åœ°é•œåƒ
    command: [string]		#å®¹å™¨çš„å¯åŠ¨å‘½ä»¤åˆ—è¡¨ï¼Œå¦‚ä¸æŒ‡å®šï¼Œä½¿ç”¨æ‰“åŒ…æ—¶ä½¿ç”¨çš„å¯åŠ¨å‘½ä»¤
    args: [string]			#å®¹å™¨çš„å¯åŠ¨å‘½ä»¤å‚æ•°åˆ—è¡¨
    workingDir: string		#å®¹å™¨çš„å·¥ä½œç›®å½•
    volumeMounts:			#æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨çš„å­˜å‚¨å·é…ç½®
    - name: string			  #å¼•ç”¨podå®šä¹‰çš„å…±äº«å­˜å‚¨å·çš„åç§°ï¼Œéœ€ç”¨volumes[]éƒ¨åˆ†å®šä¹‰çš„çš„å·å
      mountPath: string		  #å­˜å‚¨å·åœ¨å®¹å™¨å†…mountçš„ç»å¯¹è·¯å¾„ï¼Œåº”å°‘äº512å­—ç¬¦
      readOnly: boolean		  #æ˜¯å¦ä¸ºåªè¯»æ¨¡å¼
    ports:					#éœ€è¦æš´éœ²çš„ç«¯å£åº“å·åˆ—è¡¨
    - name: string			  #ç«¯å£å·åç§°
      containerPort: int	  #å®¹å™¨éœ€è¦ç›‘å¬çš„ç«¯å£å·
      hostPort: int			  #å®¹å™¨æ‰€åœ¨ä¸»æœºéœ€è¦ç›‘å¬çš„ç«¯å£å·ï¼Œé»˜è®¤ä¸Containerç›¸åŒ
      protocol: string		  #ç«¯å£åè®®ï¼Œæ”¯æŒTCPå’ŒUDPï¼Œé»˜è®¤TCP
    env:					#å®¹å™¨è¿è¡Œå‰éœ€è®¾ç½®çš„ç¯å¢ƒå˜é‡åˆ—è¡¨
    - name: string			  #ç¯å¢ƒå˜é‡åç§°
      value: string			  #ç¯å¢ƒå˜é‡çš„å€¼
    resources:				#èµ„æºé™åˆ¶å’Œè¯·æ±‚çš„è®¾ç½®
      limits:				  #èµ„æºé™åˆ¶çš„è®¾ç½®
        cpu: string			    #Cpuçš„é™åˆ¶ï¼Œå•ä½ä¸ºcoreæ•°ï¼Œå°†ç”¨äºdocker run --cpu-shareså‚æ•°
        memory: string			#å†…å­˜é™åˆ¶ï¼Œå•ä½å¯ä»¥ä¸ºMib/Gibï¼Œå°†ç”¨äºdocker run --memoryå‚æ•°
      requests:				  #èµ„æºè¯·æ±‚çš„è®¾ç½®
        cpu: string			    #Cpuè¯·æ±‚ï¼Œå®¹å™¨å¯åŠ¨çš„åˆå§‹å¯ç”¨æ•°é‡
        memory: string		    #å†…å­˜æ¸…æ¥šï¼Œå®¹å™¨å¯åŠ¨çš„åˆå§‹å¯ç”¨æ•°é‡
    livenessProbe:     		#å¯¹Podå†…ä¸ªå®¹å™¨å¥åº·æ£€æŸ¥çš„è®¾ç½®ï¼Œå½“æ¢æµ‹æ— å“åº”å‡ æ¬¡åå°†è‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ï¼Œæ£€æŸ¥æ–¹æ³•æœ‰execã€httpGetå’ŒtcpSocketï¼Œå¯¹ä¸€ä¸ªå®¹å™¨åªéœ€è®¾ç½®å…¶ä¸­ä¸€ç§æ–¹æ³•å³å¯
      exec:					#å¯¹Podå®¹å™¨å†…æ£€æŸ¥æ–¹å¼è®¾ç½®ä¸ºexecæ–¹å¼
        command: [string]	  #execæ–¹å¼éœ€è¦åˆ¶å®šçš„å‘½ä»¤æˆ–è„šæœ¬
      httpGet:				#å¯¹Podå†…ä¸ªå®¹å™¨å¥åº·æ£€æŸ¥æ–¹æ³•è®¾ç½®ä¸ºHttpGetï¼Œéœ€è¦åˆ¶å®šPathã€port
        path: string
        port: number
        host: string
        scheme: string
        HttpHeaders:
        - name: string
          value: string
      tcpSocket:			#å¯¹Podå†…ä¸ªå®¹å™¨å¥åº·æ£€æŸ¥æ–¹å¼è®¾ç½®ä¸ºtcpSocketæ–¹å¼
         port: number
       initialDelaySeconds: 0	#å®¹å™¨å¯åŠ¨å®Œæˆåé¦–æ¬¡æ¢æµ‹çš„æ—¶é—´ï¼Œå•ä½ä¸ºç§’
       timeoutSeconds: 0		#å¯¹å®¹å™¨å¥åº·æ£€æŸ¥æ¢æµ‹ç­‰å¾…å“åº”çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’ï¼Œé»˜è®¤1ç§’
       periodSeconds: 0			#å¯¹å®¹å™¨ç›‘æ§æ£€æŸ¥çš„å®šæœŸæ¢æµ‹æ—¶é—´è®¾ç½®ï¼Œå•ä½ç§’ï¼Œé»˜è®¤10ç§’ä¸€æ¬¡
       successThreshold: 0
       failureThreshold: 0
       securityContext:
         privileged:false
    restartPolicy: [Always | Never | OnFailure]		#Podçš„é‡å¯ç­–ç•¥ï¼ŒAlwaysè¡¨ç¤ºä¸€æ—¦ä¸ç®¡ä»¥ä½•ç§æ–¹å¼ç»ˆæ­¢è¿è¡Œï¼Œkubeletéƒ½å°†é‡å¯ï¼ŒOnFailureè¡¨ç¤ºåªæœ‰Podä»¥é0é€€å‡ºç é€€å‡ºæ‰é‡å¯ï¼ŒNerverè¡¨ç¤ºä¸å†é‡å¯è¯¥Pod
    nodeSelector: obeject		#è®¾ç½®NodeSelectorè¡¨ç¤ºå°†è¯¥Podè°ƒåº¦åˆ°åŒ…å«è¿™ä¸ªlabelçš„nodeä¸Šï¼Œä»¥keyï¼švalueçš„æ ¼å¼æŒ‡å®š
    imagePullSecrets:			#Pullé•œåƒæ—¶ä½¿ç”¨çš„secretåç§°ï¼Œä»¥keyï¼šsecretkeyæ ¼å¼æŒ‡å®š
    - name: string
    hostNetwork:false			#æ˜¯å¦ä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼ï¼Œé»˜è®¤ä¸ºfalseï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œè¡¨ç¤ºä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ
    volumes:					#åœ¨è¯¥podä¸Šå®šä¹‰å…±äº«å­˜å‚¨å·åˆ—è¡¨
    - name: string				  #å…±äº«å­˜å‚¨å·åç§° ï¼ˆvolumesç±»å‹æœ‰å¾ˆå¤šç§ï¼‰
      emptyDir: {}				  #ç±»å‹ä¸ºemtyDirçš„å­˜å‚¨å·ï¼Œä¸PodåŒç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªä¸´æ—¶ç›®å½•ã€‚ä¸ºç©ºå€¼
      hostPath: string			  #ç±»å‹ä¸ºhostPathçš„å­˜å‚¨å·ï¼Œè¡¨ç¤ºæŒ‚è½½Podæ‰€åœ¨å®¿ä¸»æœºçš„ç›®å½•
        path: string			    #Podæ‰€åœ¨å®¿ä¸»æœºçš„ç›®å½•ï¼Œå°†è¢«ç”¨äºåŒæœŸä¸­mountçš„ç›®å½•
      secret:					#ç±»å‹ä¸ºsecretçš„å­˜å‚¨å·ï¼ŒæŒ‚è½½é›†ç¾¤ä¸å®šä¹‰çš„secreå¯¹è±¡åˆ°å®¹å™¨å†…éƒ¨
        scretname: string  
        items:     
        - key: string
          path: string
      configMap:				#ç±»å‹ä¸ºconfigMapçš„å­˜å‚¨å·ï¼ŒæŒ‚è½½é¢„å®šä¹‰çš„configMapå¯¹è±¡åˆ°å®¹å™¨å†…éƒ¨
        name: string
        items:
        - key: string
```



- åˆ›å»ºèµ„æºå¯¹è±¡ï¼škubectl create -f nginx-deployment.yaml
- æŸ¥çœ‹åˆ›å»ºçš„èµ„æºPodï¼škubectl get pod



## 0.2ã€deployment.yaml

```yaml
apiVersion: extensions/v1beta1   #æ¥å£ç‰ˆæœ¬
kind: Deployment                 #æ¥å£ç±»å‹
metadata:
  name: cango-demo               #Deploymentåç§°
  namespace: cango-prd           #å‘½åç©ºé—´
  labels:
    app: cango-demo              #æ ‡ç­¾
spec:
  replicas: 3
  strategy:
    rollingUpdate:  ##ç”±äºreplicasä¸º3,åˆ™æ•´ä¸ªå‡çº§,podä¸ªæ•°åœ¨2-4ä¸ªä¹‹é—´
      maxSurge: 1      #æ»šåŠ¨å‡çº§æ—¶ä¼šå…ˆå¯åŠ¨1ä¸ªpod
      maxUnavailable: 1 #æ»šåŠ¨å‡çº§æ—¶å…è®¸çš„æœ€å¤§Unavailableçš„podä¸ªæ•°
  template:         
    metadata:
      labels:
        app: cango-demo  #æ¨¡æ¿åç§°å¿…å¡«
    sepc: #å®šä¹‰å®¹å™¨æ¨¡æ¿ï¼Œè¯¥æ¨¡æ¿å¯ä»¥åŒ…å«å¤šä¸ªå®¹å™¨
      containers:                                                                   
        - name: cango-demo                                                           #é•œåƒåç§°
          image: swr.cn-east-2.myhuaweicloud.com/cango-prd/cango-demo:0.0.1-SNAPSHOT #é•œåƒåœ°å€
          command: [ "/bin/sh","-c","cat /etc/config/path/to/special-key" ]    #å¯åŠ¨å‘½ä»¤
          args:                                                                #å¯åŠ¨å‚æ•°
            - '-storage.local.retention=$(STORAGE_RETENTION)'
            - '-storage.local.memory-chunks=$(STORAGE_MEMORY_CHUNKS)'
            - '-config.file=/etc/prometheus/prometheus.yml'
            - '-alertmanager.url=http://alertmanager:9093/alertmanager'
            - '-web.external-url=$(EXTERNAL_URL)'
    #å¦‚æœcommandå’Œargså‡æ²¡æœ‰å†™ï¼Œé‚£ä¹ˆç”¨Dockeré»˜è®¤çš„é…ç½®ã€‚
    #å¦‚æœcommandå†™äº†ï¼Œä½†argsæ²¡æœ‰å†™ï¼Œé‚£ä¹ˆDockeré»˜è®¤çš„é…ç½®ä¼šè¢«å¿½ç•¥è€Œä¸”ä»…ä»…æ‰§è¡Œ.yamlæ–‡ä»¶çš„commandï¼ˆä¸å¸¦ä»»ä½•å‚æ•°çš„ï¼‰ã€‚
    #å¦‚æœcommandæ²¡å†™ï¼Œä½†argså†™äº†ï¼Œé‚£ä¹ˆDockeré»˜è®¤é…ç½®çš„ENTRYPOINTçš„å‘½ä»¤è¡Œä¼šè¢«æ‰§è¡Œï¼Œä½†æ˜¯è°ƒç”¨çš„å‚æ•°æ˜¯.yamlä¸­çš„argsã€‚
    #å¦‚æœå¦‚æœcommandå’Œargséƒ½å†™äº†ï¼Œé‚£ä¹ˆDockeré»˜è®¤çš„é…ç½®è¢«å¿½ç•¥ï¼Œä½¿ç”¨.yamlçš„é…ç½®ã€‚
          imagePullPolicy: IfNotPresent  #å¦‚æœä¸å­˜åœ¨åˆ™æ‹‰å–
          livenessProbe:       #è¡¨ç¤ºcontaineræ˜¯å¦å¤„äºliveçŠ¶æ€ã€‚å¦‚æœLivenessProbeå¤±è´¥ï¼ŒLivenessProbeå°†ä¼šé€šçŸ¥kubeletå¯¹åº”çš„containerä¸å¥åº·äº†ã€‚éšåkubeletå°†killæ‰containerï¼Œå¹¶æ ¹æ®RestarPolicyè¿›è¡Œè¿›ä¸€æ­¥çš„æ“ä½œã€‚é»˜è®¤æƒ…å†µä¸‹LivenessProbeåœ¨ç¬¬ä¸€æ¬¡æ£€æµ‹ä¹‹å‰åˆå§‹åŒ–å€¼ä¸ºSuccessï¼Œå¦‚æœcontaineræ²¡æœ‰æä¾›LivenessProbeï¼Œåˆ™ä¹Ÿè®¤ä¸ºæ˜¯Successï¼›
            httpGet:
              path: /health #å¦‚æœæ²¡æœ‰å¿ƒè·³æ£€æµ‹æ¥å£å°±ä¸º/
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 60 ##å¯åŠ¨åå»¶æ—¶å¤šä¹…å¼€å§‹è¿è¡Œæ£€æµ‹
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /health #å¦‚æœæ²¡æœ‰å¿ƒè·³æ£€æµ‹æ¥å£å°±ä¸º/
              port: 8080
              scheme: HTTP
            initialDelaySeconds: 30 ##å¯åŠ¨åå»¶æ—¶å¤šä¹…å¼€å§‹è¿è¡Œæ£€æµ‹
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 5
          resources:              ##CPUå†…å­˜é™åˆ¶
            requests:
              cpu: 2
              memory: 2048Mi
            limits:
              cpu: 2
              memory: 2048Mi
          env:                    ##é€šè¿‡ç¯å¢ƒå˜é‡çš„æ–¹å¼ï¼Œç›´æ¥ä¼ é€’pod=è‡ªå®šä¹‰Linux OSç¯å¢ƒå˜é‡
            - name: LOCAL_KEY     #æœ¬åœ°Key
              value: value
            - name: CONFIG_MAP_KEY  #å±€ç­–ç•¥å¯ä½¿ç”¨configMapçš„é…ç½®Keyï¼Œ
              valueFrom:
                configMapKeyRef:
                  name: special-config   #configmapä¸­æ‰¾åˆ°nameä¸ºspecial-config
                  key: special.type      #æ‰¾åˆ°nameä¸ºspecial-configé‡Œdataä¸‹çš„key
          ports:
            - name: http
              containerPort: 8080 #å¯¹serviceæš´éœ²ç«¯å£
          volumeMounts:     #æŒ‚è½½volumesä¸­å®šä¹‰çš„ç£ç›˜
          - name: log-cache
            mount: /tmp/log
          - name: sdb       #æ™®é€šç”¨æ³•ï¼Œè¯¥å·è·Ÿéšå®¹å™¨é”€æ¯ï¼ŒæŒ‚è½½ä¸€ä¸ªç›®å½•
            mountPath: /data/media    
          - name: nfs-client-root    #ç›´æ¥æŒ‚è½½ç¡¬ç›˜æ–¹æ³•ï¼Œå¦‚æŒ‚è½½ä¸‹é¢çš„nfsç›®å½•åˆ°/mnt/nfs
            mountPath: /mnt/nfs
          - name: example-volume-config  #é«˜çº§ç”¨æ³•ç¬¬1ç§ï¼Œå°†ConfigMapçš„log-script,backup-scriptåˆ†åˆ«æŒ‚è½½åˆ°/etc/configç›®å½•ä¸‹çš„ä¸€ä¸ªç›¸å¯¹è·¯å¾„path/to/...ä¸‹ï¼Œå¦‚æœå­˜åœ¨åŒåæ–‡ä»¶ï¼Œç›´æ¥è¦†ç›–ã€‚
            mountPath: /etc/config       
          - name: rbd-pvc                #é«˜çº§ç”¨æ³•ç¬¬2ä¸­ï¼ŒæŒ‚è½½PVC(PresistentVolumeClaim)
 
#ä½¿ç”¨volumeå°†ConfigMapä½œä¸ºæ–‡ä»¶æˆ–ç›®å½•ç›´æ¥æŒ‚è½½ï¼Œå…¶ä¸­æ¯ä¸€ä¸ªkey-valueé”®å€¼å¯¹éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œkeyä¸ºæ–‡ä»¶åï¼Œvalueä¸ºå†…å®¹ï¼Œ
  volumes:  # å®šä¹‰ç£ç›˜ç»™ä¸Šé¢volumeMountsæŒ‚è½½
  - name: log-cache
    emptyDir: {}
  - name: sdb  #æŒ‚è½½å®¿ä¸»æœºä¸Šé¢çš„ç›®å½•
    hostPath:
      path: /any/path/it/will/be/replaced
  - name: example-volume-config  # ä¾›ConfigMapæ–‡ä»¶å†…å®¹åˆ°æŒ‡å®šè·¯å¾„ä½¿ç”¨
    configMap:
      name: example-volume-config  #ConfigMapä¸­åç§°
      items:
      - key: log-script           #ConfigMapä¸­çš„Key
        path: path/to/log-script  #æŒ‡å®šç›®å½•ä¸‹çš„ä¸€ä¸ªç›¸å¯¹è·¯å¾„path/to/log-script
      - key: backup-script        #ConfigMapä¸­çš„Key
        path: path/to/backup-script  #æŒ‡å®šç›®å½•ä¸‹çš„ä¸€ä¸ªç›¸å¯¹è·¯å¾„path/to/backup-script
  - name: nfs-client-root         #ä¾›æŒ‚è½½NFSå­˜å‚¨ç±»å‹
    nfs:
      server: 10.42.0.55          #NFSæœåŠ¡å™¨åœ°å€
      path: /opt/public           #showmount -e çœ‹ä¸€ä¸‹è·¯å¾„
  - name: rbd-pvc                 #æŒ‚è½½PVCç£ç›˜
    persistentVolumeClaim:
      claimName: rbd-pvc1         #æŒ‚è½½å·²ç»ç”³è¯·çš„pvcç£ç›˜

```



## 0.3ã€Service yaml

```yaml
apiVersion: v1
kind: Service
matadata:                                #å…ƒæ•°æ®
  name: string                           #serviceçš„åç§°
  namespace: string                      #å‘½åç©ºé—´  
  labels:                                #è‡ªå®šä¹‰æ ‡ç­¾å±æ€§åˆ—è¡¨
    - name: string
  annotations:                           #è‡ªå®šä¹‰æ³¨è§£å±æ€§åˆ—è¡¨  
    - name: string
spec:                                    #è¯¦ç»†æè¿°
  selector: []                           #label selectoré…ç½®ï¼Œå°†é€‰æ‹©å…·æœ‰labelæ ‡ç­¾çš„Podä½œä¸ºç®¡ç† 
                                         #èŒƒå›´
  type: string                           #serviceçš„ç±»å‹ï¼ŒæŒ‡å®šserviceçš„è®¿é—®æ–¹å¼ï¼Œé»˜è®¤ä¸º 
                                         #clusterIp
  clusterIP: string                      #è™šæ‹ŸæœåŠ¡åœ°å€      
  sessionAffinity: string                #æ˜¯å¦æ”¯æŒsession
  ports:                                 #serviceéœ€è¦æš´éœ²çš„ç«¯å£åˆ—è¡¨
  - name: string                         #ç«¯å£åç§°
    protocol: string                     #ç«¯å£åè®®ï¼Œæ”¯æŒTCPå’ŒUDPï¼Œé»˜è®¤TCP
    port: int                            #æœåŠ¡ç›‘å¬çš„ç«¯å£å·
    targetPort: int                      #éœ€è¦è½¬å‘åˆ°åç«¯Podçš„ç«¯å£å·
    nodePort: int                        #å½“type = NodePortæ—¶ï¼ŒæŒ‡å®šæ˜ å°„åˆ°ç‰©ç†æœºçš„ç«¯å£å·
  status:                                #å½“spce.type=LoadBalanceræ—¶ï¼Œè®¾ç½®å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„åœ°å€
    loadBalancer:                        #å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨    
      ingress:                           #å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ 
        ip: string                       #å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„Ipåœ°å€å€¼
        hostname: string                 #å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„ä¸»æœºå
```







# 1ã€å­˜å‚¨æŠ½è±¡

æ¯ä¸ªPodéƒ½ä¼šåœ¨å®¿ä¸»æœºä¸Šè¿›è¡Œæ•°æ®å·æŒ‚è½½ï¼Œè¿™æ ·ä¿®æ”¹å®¿ä¸»æœºçš„æ•°æ®å·ï¼Œå°±å¯ä»¥ä¿®æ”¹Podé‡Œé¢çš„å†…å®¹ã€‚è¿™æ˜¯ä¹‹å‰Dockerçš„æ€æƒ³ï¼Œä½†æ˜¯åœ¨K8sé‡Œé¢ï¼Œå¦‚æœnode1æœºå™¨çš„podå®•æœºäº†ï¼ŒK8sæ ¹æ®æ•…éšœè½¬ç§»ï¼Œå°†å®•æœºçš„podåœ¨node2æœºå™¨å¯åŠ¨ï¼Œå¯æ˜¯è¿™ä¸ªpodçš„æŒ‚è½½ç›®å½•è¿˜ä¾ç„¶åœ¨node1æœºå™¨å‘¢ï¼

æ‰€ä»¥K8sä¸ºäº†è§£å†³å¦‚ä¸Šé—®é¢˜ï¼Œå°†æ‰€æœ‰çš„podæŒ‚è½½ç»Ÿä¸€ä¸ºå­˜å‚¨å±‚ã€‚æˆ‘ä»¬å¯ä»¥åœ¨masterèŠ‚ç‚¹æ­å»ºä¸€ä¸ªNFSæ–‡ä»¶å­˜å‚¨ç³»ç»Ÿä½œä¸ºNFSçš„æœåŠ¡ç«¯ï¼ŒNode1ã€Node2ä¹Ÿæ­å»ºNFSä½œä¸ºNFSçš„å®¢æˆ·ç«¯ï¼Œå½“NFSçš„æœåŠ¡ç«¯æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œå®¢æˆ·ç«¯ä¼šè‡ªåŠ¨åŒæ­¥ã€‚

![](äº‘åŸç”Ÿ(äºŒ).assets/1.png)



## 1.1ã€å®‰è£…NFS

```bash
# æ‰€æœ‰èŠ‚ç‚¹å®‰è£…NFS
yum install -y nfs-utils
```

```bash
# ä¸»èŠ‚ç‚¹master
echo "/nfs/data/ *(insecure,rw,sync,no_root_squash)" > /etc/exports
```

- å°†`/nfs/data/`ç›®å½•è®¾ç½®ä¸ºå…±äº«ç›®å½•ï¼Œæ„å‘³ç€è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶å’Œå­ç›®å½•å°†å¯ä»¥è¢«å…¶ä»–ä¸»æœºé€šè¿‡ç½‘ç»œè®¿é—®
- **`*`**ï¼šè¡¨ç¤ºå…è®¸æ‰€æœ‰çš„ä¸»æœºè®¿é—®è¿™ä¸ªå…±äº«ç›®å½•ã€‚ä¹Ÿå¯ä»¥æŒ‡å®šå…·ä½“çš„ IP åœ°å€æˆ–ç½‘æ®µï¼Œå¦‚`192.168.1.0/24`è¡¨ç¤ºå…è®¸è¯¥ç½‘æ®µå†…çš„ä¸»æœºè®¿é—®ã€‚
- **`insecure`**ï¼šå…è®¸ä»å®¢æˆ·ç«¯æ¥çš„éæˆæƒè®¿é—®ï¼Œä¸€èˆ¬ç”¨äºå®¢æˆ·ç«¯å¯èƒ½ä½¿ç”¨å¤§äº 1024 çš„ç«¯å£è¿›è¡Œ NFS è¿æ¥çš„æƒ…å†µã€‚
- **`rw`**ï¼šè¡¨ç¤ºè¯¥å…±äº«ç›®å½•å¯¹å®¢æˆ·ç«¯æ¥è¯´æ˜¯å¯è¯»å¯å†™çš„ï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨è¿™ä¸ªå…±äº«ç›®å½•ä¸­è¿›è¡Œè¯»å–å’Œå†™å…¥æ–‡ä»¶ç­‰æ“ä½œã€‚
- **`sync`**ï¼šè¡¨ç¤ºæ•°æ®åŒæ­¥å†™å…¥ç£ç›˜ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ï¼Œå³æ•°æ®ä¼šå…ˆå†™å…¥åˆ°ç£ç›˜ï¼Œç„¶åå†è¿”å›æ“ä½œæˆåŠŸçš„ä¿¡å·ï¼Œè¿™æ ·å¯ä»¥é¿å…æ•°æ®ä¸¢å¤±ï¼Œä½†å¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚
- **`no_root_squash`**ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œå½“å®¢æˆ·ç«¯ä»¥ root ç”¨æˆ·è®¿é—® NFS å…±äº«æ—¶ï¼ŒæœåŠ¡å™¨ä¼šå°†å…¶æ˜ å°„ä¸ºä¸€ä¸ªé root ç”¨æˆ·ï¼Œä»¥å¢å¼ºå®‰å…¨æ€§ã€‚è€Œ`no_root_squash`åˆ™è¡¨ç¤ºä¸è¿›è¡Œè¿™ç§æ˜ å°„ï¼Œå®¢æˆ·ç«¯çš„ root ç”¨æˆ·åœ¨è®¿é—®å…±äº«ç›®å½•æ—¶å°†å…·æœ‰ root æƒé™ï¼Œè¿™å¯èƒ½ä¼šå¸¦æ¥ä¸€å®šçš„å®‰å…¨é£é™©ï¼Œä½†åœ¨æŸäº›ç‰¹å®šçš„åœºæ™¯ä¸‹å¯èƒ½æ˜¯å¿…è¦çš„ã€‚

### 1.1.1ã€æŒ‚è½½NFS	

```bash
# ä¸»èŠ‚ç‚¹
mkdir -p /nfs/data
# å°† rpcbind æœåŠ¡è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ï¼Œå¹¶ä¸”ç«‹å³å¯åŠ¨è¯¥æœåŠ¡ã€‚
systemctl enable rpcbind --now
# å°† nfs-server æœåŠ¡è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ï¼Œå¹¶ä¸”ç«‹å³å¯åŠ¨è¯¥æœåŠ¡ã€‚
systemctl enable nfs-server --now
#é…ç½®ç”Ÿæ•ˆ
exportfs -r
```

```bash
# ä»èŠ‚ç‚¹
# æŸ¥çœ‹masterå“ªä¸ªç›®å½•æ˜¯å…±äº«ç›®å½•
showmount -e MasterèŠ‚ç‚¹ip

#æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŒ‚è½½ nfs æœåŠ¡å™¨ä¸Šçš„å…±äº«ç›®å½•åˆ°æœ¬æœºè·¯å¾„ /root/nfsmount
mkdir -p /nfs/data
mount -t nfs MasterèŠ‚ç‚¹ip:/nfs/data /nfs/data

# å†™å…¥ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
echo "hello nfs server" > /nfs/data/test.txt
```



### 1.1.2ã€ä½¿ç”¨yamlæŒ‚è½½NFS

![](äº‘åŸç”Ÿ(äºŒ).assets/2.png)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx-pv-demo
  name: nginx-pv-demo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-pv-demo
  template:
    metadata:
      labels:
        app: nginx-pv-demo
    spec:
      containers:
      - image: nginx
        name: nginx
        # å·æŒ‚è½½
        volumeMounts:
        # nginxé‡Œé¢çš„ /usr/share/nginx/html ç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœºä¸Šï¼Œåå­—å«htmlï¼Œå¯¹åº”ä¸‹æ–¹çš„ volumes
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
        - name: html
         # åå«htmlçš„ä»¥nfsæŒ‚è½½æ–¹å¼æŒ‚è½½
          nfs:
            server: masterèŠ‚ç‚¹çš„ip
            path: /nfs/data/nginx-pv
```



- å…¶å®ä¹Ÿå°±æ˜¯ nginx å®¹å™¨çš„ /usr/share/nginx/html è·¯å¾„æŒ‚è½½åˆ° master èŠ‚ç‚¹çš„ /nfs/data/nginx-pv

> æ³¨æ„è¦åœ¨masterèŠ‚ç‚¹å…ˆåˆ›å»º`/nfs/data/nginx-pv` ç›®å½•





## 1.2ã€PVå’ŒPVC

æˆ‘ä»¬ä¸Šé¢NFSå…±äº«ç›®å½•çš„æ–¹å¼å…¶å®å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š

1. masterèŠ‚ç‚¹çš„å…±äº«ç›®å½•éœ€è¦è‡ªå·±æå‰æ‰‹åŠ¨åˆ›å»º
2. å¦‚æœnginx pod åˆ é™¤äº†åï¼Œå®ƒæŒ‚è½½çš„ç›®å½•(å³` /nfs/data/nginx-pv`)ç›®å½•ä¸ä¼šè‡ªåŠ¨åˆ é™¤ã€‚

æ‰€ä»¥K8Sè¿˜æœ‰å¦ä¸€ç§æ–¹å¼å¯ä»¥è¿›è¡ŒæŒ‚è½½ï¼šPVå’ŒPVC

- *PVï¼šæŒä¹…å·ï¼ˆPersistent Volumeï¼‰ï¼Œå°†åº”ç”¨éœ€è¦æŒä¹…åŒ–çš„æ•°æ®ä¿å­˜åˆ°æŒ‡å®šä½ç½®*
- *PVCï¼šæŒä¹…å·ç”³æ˜ï¼ˆ**Persistent Volume Claim**ï¼‰ï¼Œç”³æ˜éœ€è¦ä½¿ç”¨çš„æŒä¹…å·è§„æ ¼ï¼Œæ¯”å¦‚ç»™æŒä¹…å·20MB*

![](äº‘åŸç”Ÿ(äºŒ).assets/3.png)



æˆ‘ä»¬å¯ä»¥å…ˆåœ¨æœºå™¨ä¸Šæå‰åˆ›å»ºè®¸å¤šæŒä¹…å·PVï¼Œè¿™äº›æŒä¹…å·PVç»Ÿä¸€ç§°ä¸ºPVæ± ã€‚

- å½“æŸä¸ªPodéœ€è¦æŒ‚è½½`/data`ç›®å½•åˆ°æŒä¹…å·ï¼Œå…ˆå†™ä¸€ä»½PVCç”³è¯·ï¼Œç”³è¯·éœ€è¦å¤šå¤§çš„æŒä¹…å·ï¼Œç„¶åK8så†æ ¹æ®ç”³è¯·ä¹¦ç»™å®ƒåˆ†é…æœ€åˆé€‚çš„ã€‚
- å½“Podå‘ç”Ÿæ•…éšœè½¬ç§»ï¼Œå…¶PVCç”³è¯·ä¸å˜ï¼Œä¾ç„¶ä¼šç»™å®ƒè‡ªå·±å¯¹åº”çš„PV
- å½“Podåˆ é™¤æ‰åï¼Œå…¶PVCä¹Ÿä¼šè¢«åˆ é™¤ï¼Œè¿å¸¦ç€ç”³è¯·çš„PVä¹Ÿä¼šè¢«åˆ é™¤ã€‚

åˆ›å»ºPVï¼š

```bash
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv01-10m
spec:
  capacity:
   # ç”³è¯·10Mçš„PV
    storage: 10M
  accessModes:
   # å¯è¯»å¯å†™
    - ReadWriteMany
  storageClassName: nfs
  nfs:
    path: /nfs/data/01
    server: èŠ‚ç‚¹ip
---

apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv02-1gi
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteMany
  storageClassName: nfs
  nfs:
    path: /nfs/data/02
    server: èŠ‚ç‚¹ip
---

apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv03-3gi
spec:
  capacity:
    storage: 3Gi
  accessModes:
    - ReadWriteMany
  storageClassName: nfs
  nfs:
    path: /nfs/data/03
    server: èŠ‚ç‚¹ip
```

- åˆ›å»ºPVC

```yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: nginx-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      # ç”³è¯·200MBçš„PV
      storage: 200Mi
  # å¯¹åº”åˆ›å»ºPVçš„    storageClassName å
  storageClassName: nfs
```

å½“ç„¶åœ¨ç”³è¯·ä¹‹å‰å¯ä»¥ä½¿ç”¨`kubectl get pv`æ¥æŸ¥çœ‹å½“å‰æœ‰å¤šå°‘å’Œå¤šå¤§çš„PVã€‚

- ğŸ”¥åˆ›å»ºPodç»‘å®šPVC:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx-deploy-pvc
  name: nginx-deploy-pvc
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-deploy-pvc
  template:
    metadata:
      labels:
        app: nginx-deploy-pvc
    spec:
      containers:
      - image: nginx
        name: nginx
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
        - name: html
          # ä½¿ç”¨nginx-pvcçš„ç”³è¯·ä¹¦(æˆ‘ä»¬ä¸Šé¢ç”³è¯·PVCçš„åå­—æ˜¯nginx-pvc)
          persistentVolumeClaim:
            claimName: nginx-pvc
```

ä¹Ÿå¯ä»¥ä½¿ç”¨`kubectl get pvc`æ¥æŸ¥çœ‹ç”³è¯·ä¹¦ã€‚





## 1.3ã€ConfigMap

ä¸Šé¢çš„éƒ½æ˜¯æŒ‚è½½ç›®å½•ï¼Œå¯æ˜¯å¦‚æœæˆ‘ä»¬è¦æŒ‚è½½æ–‡ä»¶æ€ä¹ˆåŠï¼Ÿæ¯”å¦‚è¦æŠŠredisçš„confæ–‡ä»¶æŒ‚è½½å‡ºæ¥ï¼Œè¿™ä¸ªæ—¶å€™ä½¿ç”¨ConfigMapæœ€å¥½ï¼š

```bash
# åˆ›å»ºä¸€ä¸ªConfigMapï¼Œåå­—ä¸º redis-conf
# --from-file æ˜¯ä¸€ä¸ªé€‰é¡¹ï¼Œç”¨äºæŒ‡å®šä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®å¹¶å°†å…¶æ·»åŠ åˆ° ConfigMap ä¸­
kubectl create cm redis-conf --from-file=redis.conf

# è·å–é…ç½®é›†ConfigMap(cmå…¶å®éƒ½æ˜¯å­˜å‚¨åœ¨etcdé‡Œé¢)
kubectl get cm
```

yamlæ–¹å¼å¦‚ä¸‹ï¼š

```yaml
apiVersion: v1
data:    #dataæ˜¯æ‰€æœ‰çœŸæ­£çš„æ•°æ®ï¼Œkeyï¼šé»˜è®¤æ˜¯æ–‡ä»¶å   valueï¼šé…ç½®æ–‡ä»¶çš„å†…å®¹
  redis.conf: |
    appendonly yes
kind: ConfigMap
metadata:
  name: redis-conf
  namespace: default
```

- `|` æ˜¯ YAML ä¸­çš„å¤šè¡Œæ–‡æœ¬æ ‡è¯†ç¬¦å·ï¼Œå®ƒè¡¨ç¤ºåé¢çš„å†…å®¹æ˜¯å¤šè¡Œæ–‡æœ¬ï¼Œå¹¶ä¸”ä¼šä¿ç•™æ–‡æœ¬ä¸­çš„æ¢è¡Œç¬¦ã€‚

åˆ›å»ºPodæ—¶æŒ‚è½½æ–‡ä»¶ï¼š

```yaml
# æŒ‡å®š Kubernetes API çš„ç‰ˆæœ¬ï¼Œv1 æ˜¯æ ¸å¿ƒ API ç‰ˆæœ¬ï¼Œé€‚ç”¨äºåŸºç¡€èµ„æºå¦‚ Pod
apiVersion: v1
# å®šä¹‰èµ„æºçš„ç±»å‹ï¼Œè¿™é‡Œæ˜¯ Podï¼ŒPod æ˜¯ Kubernetes ä¸­æœ€å°çš„å¯éƒ¨ç½²å•å…ƒ
kind: Pod
# å…ƒæ•°æ®éƒ¨åˆ†ï¼ŒåŒ…å« Pod çš„ä¸€äº›æ ‡è¯†ä¿¡æ¯
metadata:
  # Pod çš„åç§°ï¼Œç”¨äºåœ¨ Kubernetes é›†ç¾¤ä¸­å”¯ä¸€æ ‡è¯†è¿™ä¸ª Pod
  name: redis
# Pod çš„è§„æ ¼éƒ¨åˆ†ï¼Œæè¿°äº† Pod çš„å…·ä½“é…ç½®
spec:
  # å®šä¹‰ Pod å†…çš„å®¹å™¨åˆ—è¡¨ï¼Œä¸€ä¸ª Pod å¯ä»¥åŒ…å«å¤šä¸ªå®¹å™¨
  containers:
  # ç¬¬ä¸€ä¸ªå®¹å™¨çš„é…ç½®
  - name: redis
    # æŒ‡å®šå®¹å™¨ä½¿ç”¨çš„é•œåƒï¼Œè¿™é‡Œä½¿ç”¨å®˜æ–¹çš„ Redis é•œåƒ
    image: redis
    # å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤
    command:
      # å¯åŠ¨ Redis æœåŠ¡å™¨
      - redis-server
      # æŒ‡å®š Redis æœåŠ¡å™¨ä½¿ç”¨çš„é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œè¿™é‡Œæ˜¯å®¹å™¨å†…éƒ¨çš„è·¯å¾„
      - "/redis-master/redis.conf"  #æŒ‡çš„æ˜¯rediså®¹å™¨å†…éƒ¨çš„ä½ç½®
    # å®¹å™¨æš´éœ²çš„ç«¯å£åˆ—è¡¨
    ports:
    # å®šä¹‰å®¹å™¨å†…éƒ¨ç›‘å¬çš„ç«¯å£
    - containerPort: 6379
    # å®¹å™¨å†…çš„æŒ‚è½½ç‚¹é…ç½®ï¼Œç”¨äºå°†å·æŒ‚è½½åˆ°å®¹å™¨å†…çš„æŒ‡å®šè·¯å¾„
    volumeMounts:
    # ç¬¬ä¸€ä¸ªæŒ‚è½½ç‚¹
    - mountPath: /data
      # å¯¹åº”çš„å·åç§°ï¼Œç”¨äºå…³è”åˆ°ä¸‹é¢ volumes éƒ¨åˆ†å®šä¹‰çš„å·
      name: data
    # ç¬¬äºŒä¸ªæŒ‚è½½ç‚¹
    - mountPath: /redis-master
      # å¯¹åº”çš„å·åç§°ï¼Œç”¨äºå…³è”åˆ°ä¸‹é¢ volumes éƒ¨åˆ†å®šä¹‰çš„å·
      name: config
  # å®šä¹‰ Pod ä¸­ä½¿ç”¨çš„å·åˆ—è¡¨ï¼Œå·ç”¨äºåœ¨å®¹å™¨ä¹‹é—´å…±äº«æ•°æ®æˆ–æŒä¹…åŒ–æ•°æ®
  volumes:
  # ç¬¬ä¸€ä¸ªå·çš„é…ç½®
  - name: data
    # ä½¿ç”¨ emptyDir ç±»å‹çš„å·ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸´æ—¶å­˜å‚¨å·ï¼ŒPod å­˜åœ¨æœŸé—´æ•°æ®ä¼šä¿ç•™
    emptyDir: {}
  # ç¬¬äºŒä¸ªå·çš„é…ç½®
  - name: config
    # ä½¿ç”¨ ConfigMap ç±»å‹çš„å·ï¼Œç”¨äºå°† ConfigMap ä¸­çš„æ•°æ®æŒ‚è½½åˆ°å®¹å™¨ä¸­
    configMap:
      # æŒ‡å®šè¦ä½¿ç”¨çš„ ConfigMap çš„åç§°
      name: redis-conf
      # å®šä¹‰è¦ä» ConfigMap ä¸­è·å–çš„å…·ä½“é¡¹
      items:
      # ä» ConfigMap ä¸­è·å–é”®ä¸º redis.conf çš„æ•°æ®
      - key: redis.conf
        # å°†è·å–çš„æ•°æ®æŒ‚è½½åˆ°å®¹å™¨å†…çš„æŒ‡å®šè·¯å¾„
        path: redis.conf
```

è¿™ä¸ª YAML æ–‡ä»¶å®šä¹‰äº†ä¸€ä¸ªåä¸º `redis` çš„ Podï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª Redis å®¹å™¨ã€‚è¯¥å®¹å™¨ä½¿ç”¨ `redis` é•œåƒï¼Œå¯åŠ¨æ—¶ä½¿ç”¨ `/redis-master/redis.conf` ä½œä¸ºé…ç½®æ–‡ä»¶ï¼Œå¹¶ç›‘å¬ 6379 ç«¯å£ã€‚

å®¹å™¨æŒ‚è½½äº†ä¸¤ä¸ªå·ï¼Œä¸€ä¸ªæ˜¯ `emptyDir` ç±»å‹çš„å·ç”¨äºä¸´æ—¶å­˜å‚¨æ•°æ®ï¼Œå¦ä¸€ä¸ªæ˜¯ `ConfigMap` ç±»å‹çš„å·ï¼Œç”¨äºå°†åä¸º `redis-conf` çš„ ConfigMap ä¸­çš„ `redis.conf` æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨å†…çš„ `/redis-master` ç›®å½•ä¸‹ã€‚







## 1.4ã€Secret

Secret å¯¹è±¡ç±»å‹ç”¨æ¥ä¿å­˜æ•æ„Ÿä¿¡æ¯ï¼Œä¾‹å¦‚**å¯†ç ã€OAuth ä»¤ç‰Œå’Œ SSH å¯†é’¥**ã€‚ å°†è¿™äº›ä¿¡æ¯æ”¾åœ¨ secret ä¸­æ¯”æ”¾åœ¨ Pod çš„å®šä¹‰æˆ–è€…å®¹å™¨é•œåƒä¸­æ¥è¯´æ›´åŠ å®‰å…¨å’Œçµæ´»ã€‚































