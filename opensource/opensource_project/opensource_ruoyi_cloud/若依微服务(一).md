# 1ã€RuoYi-Clouid

æˆ‘è¿™é‡Œå°†éƒ¨åˆ†æœåŠ¡éƒ¨ç½²åœ¨äº‘ä¸ŠæœåŠ¡å™¨

## 1.1ã€å¯¼å…¥æ•°æ®åº“

1. ä¸‹è½½æºç ï¼Œè§£å‹ï¼Œå°†`ruoyi-ui`æ”¾åˆ°webstromä¸­
2. å°†å…¶ä»–ç›®å½•åŠ è½½è¿› IDEA ä¸­ï¼Œç­‰å¾…IDEAåŠ è½½ä¾èµ–
3. åœ¨å®å¡”åˆ›å»ºæ•°æ®åº“`kuangstudy_cloud`ï¼Œè®¿é—®æƒé™é€‰æ‹©æ‰€æœ‰äººã€‚å†åˆ›å»ºæ•°æ®åº“`kuangstudy_config`

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/1.png)

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/2.png)

4. ä½¿ç”¨Navicatè¿æ¥æ•°æ®åº“`kuangstudy_cloud`ï¼Œå¯¼å…¥æ•°æ®è„šæœ¬`ry_2024xxxx.sql`ï¼ˆå¿…é¡»ï¼‰ï¼Œ`quartz.sql`ï¼ˆå¯é€‰ï¼‰

5. ä½¿ç”¨Navicatè¿æ¥æ•°æ®åº“`kuangstudy_config`ï¼Œå¯¼å…¥æ•°æ®è„šæœ¬`ry_config_2024xxxx.sql`ï¼ˆå¿…é¡»ï¼‰

> [!WARNING]
>
> æ³¨æ„: åœ¨æ‰§è¡Œ `ry_config_2024xxxx.sql` æ—¶å€™ï¼Œéœ€è¦æå‰è¿›å…¥ sql ï¼Œå°†`ry-config`æ›¿æ¢ä¸º`kuangstudy-config`
>
> å¦‚æœä½ æ•°æ®åº“èµ·åä¸º`ry-config`ï¼Œåˆ™ä¸éœ€è¦æ‰§è¡Œè¿™ä¸€æ­¥ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/3.png)



## 1.2ã€Dockerä¸­è¿è¡ŒNacos

æˆ‘ä»¬è¦é¦–å…ˆå®‰è£…Dockerï¼ŒDockerçš„å®‰è£…å¯ä»¥ä½¿ç”¨å‘½ä»¤ä¹Ÿå¯ä»¥ä½¿ç”¨å®å¡”ä¸€é”®å®‰è£…ï¼Œæˆ‘è¿™è¾¹ä½¿ç”¨å®å¡”è¿›è¡Œå®‰è£…ã€‚

> [!NOTE]
>
> è¿™é‡Œæˆ‘è´´ä¸Šæˆ‘è‡ªå·±çš„Dockerç¬”è®°ï¼Œé‡Œé¢æœ‰ç›¸å…³çš„å®‰è£…å‘½ä»¤ï¼Œéå¸¸è¯¦ç»†ã€‚
>
> - [Dockeré•œåƒå‘½ä»¤ä¸å®¹å™¨å‘½ä»¤åŠæ•°æ®å·(ä¸€)](https://blog.csdn.net/Augenstern_QXL/article/details/136801394)
> - [Dockerç½‘æ¡¥ã€DockerFileè‡ªå®šä¹‰é•œåƒã€DockerComposeå·¥å…·(äºŒ)](https://blog.csdn.net/Augenstern_QXL/article/details/136801933)



1. åœ¨å®å¡”åå°å®‰è£…Dockerï¼Œç‚¹å‡»Docker - ç«‹å³å®‰è£… - è¿™é‡Œæˆ‘é€‰æ‹©é˜¿é‡Œäº‘é•œåƒå®‰è£…

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/4.png)

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/5.png)





2. å®‰è£…å®Œæˆåè®¾ç½®åŠ é€ŸURLï¼Œæˆ‘é€‰æ‹©çš„æ˜¯é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿç«™ï¼Œç„¶åé‡å¯Docker

> æˆ–è€…ä¹Ÿå¯ä»¥å‚è€ƒæ•™ç¨‹è´´è®¾ç½®è‡ªå·±çš„å®¹å™¨åŠ é€Ÿï¼š[å¦‚ä½•åœ¨å®å¡”é¢æ¿æ›´æ¢DockeråŠ é€Ÿç«™](https://www.bt.cn/bbs/thread-134771-1-1.html)
>
> åªæ˜¯æˆ‘è¿™è¾¹å‘ç°è®¾ç½®äº†ä¸å›æ˜¾,æ‰§è¡Œå‘½ä»¤`cat /etc/docker/daemon.json`ä¹Ÿæ— æ­¤æ–‡ä»¶ï¼Œè¯´æ˜å®å¡”é¢æ¿çš„åŠ é€ŸURLçš„è®¾ç½®æ²¡ç”Ÿæ•ˆï¼Œæ‰€ä»¥æˆ‘æ˜¯ç›´æ¥æ›´æ¢äº†[é•œåƒåŠ é€Ÿ](https://blog.csdn.net/Augenstern_QXL/article/details/136801394?spm=1001.2014.3001.5501)

å®‰è£…æˆåŠŸåï¼Œåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ`docker -v`å³å¯çœ‹åˆ°å®‰è£…çš„ç‰ˆæœ¬

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/6.png)

3. å®å¡”é¢æ¿çš„åº”ç”¨å•†åº—åªæœ‰ä¸ªåˆ«çš„é•œåƒï¼Œæˆ‘æ²¡æœåˆ°nacosé•œåƒï¼Œæ‰€ä»¥è¿˜æ˜¯å¾—å‘½ä»¤æ‰§è¡Œæ‹‰å–nacosé•œåƒ

```bash
docker pull nacos/nacos-server
```

4. è¿è¡Œnacoså®¹å™¨

```bash
docker run -d \
--name nacos \
-e PREFER_HOST_MODE=hostname \
-e MODE=standalone \
-e SPRING_DATASOURCE_PLATFORM=mysql \
-e MYSQL_SERVICE_HOST=49.232.28.14 \
-e MYSQL_SERVICE_PORT=3306 \
-e MYSQL_SERVICE_USER=kuang_config \
-e MYSQL_SERVICE_PASSWORD=123456 \
-e MYSQL_SERVICE_DB_NAME=kuangstudy_config \
-e JVM_XMS=256m \
-e JVM_XMX=256m \
--network=host \
nacos/nacos-server
```

> `docker run` å‘½ä»¤ç”¨æ¥åœ¨Dockerä¸­å¯åŠ¨ä¸€ä¸ªNacosæœåŠ¡å™¨å®¹å™¨ã€‚è®©æˆ‘ä»¬é€ä¸ªè§£æå‚æ•°å’Œå®ƒä»¬çš„ä½œç”¨ï¼š
>
> - `-d`ï¼šä»¥å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰æ¨¡å¼è¿è¡Œå®¹å™¨ï¼Œè¿™æ„å‘³ç€å®¹å™¨å°†åœ¨åå°è¿è¡Œã€‚
> - `--name nacos`ï¼šä¸ºå®¹å™¨å‘½åï¼Œè¿™é‡Œå‘½åä¸º `nacos`ã€‚
> - `-e`ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å…·ä½“çš„ç¯å¢ƒå˜é‡åŠå…¶ä½œç”¨ï¼š
>   - `PREFER_HOST_MODE=hostname`ï¼šæŒ‡ç¤ºNacosä¼˜å…ˆä½¿ç”¨ä¸»æœºåè€Œä¸æ˜¯IPåœ°å€è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚
>   - `MODE=standalone`ï¼šæŒ‡å®šNacosè¿è¡Œæ¨¡å¼ä¸ºç‹¬ç«‹æ¨¡å¼ï¼Œå³å•æœºæ¨¡å¼ã€‚
>   - `SPRING_DATASOURCE_PLATFORM=mysql`ï¼šå‘Šè¯‰Nacosæ•°æ®æºå¹³å°æ˜¯MySQLã€‚
>   - `MYSQL_SERVICE_HOST=49.232.28.14`ï¼šMySQLæœåŠ¡çš„ä¸»æœºåœ°å€ã€‚
>   - `MYSQL_SERVICE_PORT=3306`ï¼šMySQLæœåŠ¡çš„ç«¯å£ã€‚
>   - `MYSQL_SERVICE_USER=kuang_config`ï¼šç”¨äºè¿æ¥MySQLæ•°æ®åº“çš„ç”¨æˆ·åã€‚
>   - `MYSQL_SERVICE_PASSWORD=123456`ï¼šè¿æ¥MySQLæ•°æ®åº“çš„å¯†ç ã€‚
>   - `MYSQL_SERVICE_DB_NAME=kuangstudy_config`ï¼šè¦ä½¿ç”¨çš„MySQLæ•°æ®åº“åç§°ã€‚
>   - `JVM_XMS=256m`ï¼šè®¾ç½®JVMåˆå§‹å †å†…å­˜å¤§å°ä¸º256MBã€‚
>   - `JVM_XMX=256m`ï¼šè®¾ç½®JVMæœ€å¤§å †å†…å­˜å¤§å°ä¸º256MBã€‚
> - `--network=host`ï¼šä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œæ¨¡å¼ï¼Œè¿™å°†ä½¿å®¹å™¨å…±äº«å®¿ä¸»æœºçš„ç½‘ç»œæ ˆï¼Œå› æ­¤å®¹å™¨å°†ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œæ¥å£ã€‚
> - `nacos/nacos-server`ï¼šæŒ‡å®šè¦è¿è¡Œçš„Dockeré•œåƒï¼Œè¿™é‡Œæ˜¯NacosæœåŠ¡å™¨çš„å®˜æ–¹é•œåƒã€‚
>
> æ­¤å¤–ï¼Œä½¿ç”¨ `--network=host` å¯èƒ½ä¼šå¸¦æ¥å®‰å…¨é£é™©ï¼Œå› ä¸ºå®ƒå…è®¸å®¹å™¨ç›´æ¥è®¿é—®å®¿ä¸»æœºçš„ç½‘ç»œï¼Œè¿™å¯èƒ½ä¼šæš´éœ²å®¿ä¸»æœºä¸Šçš„å…¶ä»–æœåŠ¡ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé€šå¸¸å»ºè®®ä½¿ç”¨æ›´å®‰å…¨çš„ç½‘ç»œæ¨¡å¼ï¼Œå¦‚æ¡¥æ¥ç½‘ç»œæˆ–ç”¨æˆ·å®šä¹‰çš„ç½‘ç»œã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/7.png)

åœ¨å®å¡”é¢æ¿å¯ä»¥ç‚¹å‡»å®¹å™¨ï¼Œçœ‹åˆ°æˆ‘ä»¬çš„nacoså®¹å™¨æ­£åœ¨è¿è¡Œã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/8.png)



5. è®¿é—®ï¼š`http://æœåŠ¡å™¨ip:8848/nacos`ï¼Œé»˜è®¤è´¦å·å¯†ç éƒ½æ˜¯ `nacos`

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/9.png)

> [!NOTE]
>
> æ³¨æ„ï¼šè®°å¾—å®å¡”é¢æ¿å’Œäº‘æœåŠ¡å™¨å¼€å¯8848é˜²ç«å¢™ç«¯å£å‘¦ï¼å®˜æ–¹æ–‡æ¡£è¯´å¼€8848å’Œ9848å°±å¯ä»¥æ»¡è¶³å¤§å¤šæ•°åœºæ™¯ä¸‹çš„ç½‘ç»œé…ç½®éœ€æ±‚ã€‚ç™»å½•æˆåŠŸåå°±å¯ä»¥çœ‹åˆ°å¦‚ä¸‹é¡µé¢ï¼Œè€Œè¡¨æ ¼ä¸­çš„æ•°æ®å°±æ˜¯æˆ‘ä»¬å¯¼å…¥çš„ config é…ç½®ã€‚
>
> [[å®˜æ–¹æ–‡æ¡£]nacosé»˜è®¤éœ€è¦æ”¾å¼€å“ªå‡ ä¸ªç«¯å£å·](https://nacos.io/blog/faq/nacos-user-question-history15418/)

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/10.png)





## 1.3ã€è¿è¡Œç½‘å…³Gatewayæ¨¡å—

- RuoYiGatewayApplication ï¼ˆç½‘å…³æ¨¡å— **å¿…é¡»**ï¼‰
- RuoYiAuthApplication ï¼ˆè®¤è¯æ¨¡å— **å¿…é¡»**ï¼‰
- RuoYiSystemApplication ï¼ˆç³»ç»Ÿæ¨¡å— **å¿…é¡»**ï¼‰
- RuoYiMonitorApplication ï¼ˆç›‘æ§ä¸­å¿ƒ å¯é€‰ï¼‰
- RuoYiGenApplication ï¼ˆä»£ç ç”Ÿæˆ å¯é€‰ï¼‰
- RuoYiJobApplication ï¼ˆå®šæ—¶ä»»åŠ¡ å¯é€‰ï¼‰
- RuoYFileApplication ï¼ˆæ–‡ä»¶æœåŠ¡ å¯é€‰ï¼‰



åœ¨çœŸæ­£éƒ¨ç½²èµ·æ¥åï¼Œå‰ç«¯æ‰€æœ‰çš„APIè¯·æ±‚éƒ½ä¼šé€šè¿‡Nginxï¼ŒNginxä¼šå°†è¯·æ±‚è½¬å‘åˆ°ç½‘å…³æ¨¡å—ï¼Œä¹Ÿå°±æ˜¯ 8080 ç«¯å£ï¼Œä¹‹åç”±åç«¯çš„ç½‘å…³æ¨¡å—å†å»è¿›è¡Œä¸€ä¸ªè½¬å‘ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/11.png)

1. ä¿®æ”¹`ruoyi-gateway`æ¨¡å—ä¸‹çš„ `bootstrap.yml`

   åªéœ€è¦æ›´æ”¹ä¸‰ä¸ªåœ°æ–¹çš„ipï¼ŒæœåŠ¡æ³¨å†Œåœ°å€ã€é…ç½®ä¸­å¿ƒåœ°å€ã€nacosé…ç½®æŒä¹…åŒ–ï¼Œæ§åˆ¶å°åœ°å€ipä¸éœ€è¦æ”¹åŠ¨

```yaml
# Tomcat
server:
  port: 8080

# Spring
spring: 
  application:
    # åº”ç”¨åç§°ï¼šå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œçš„æ—¶å€™ç”¨çš„åç§°
    name: ruoyi-gateway
  profiles:
    # ç¯å¢ƒé…ç½® æŒ‡å®šäº†å½“å‰ç¯å¢ƒé…ç½®ä¸º devï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    active: dev
  cloud:
    nacos:
      # discovery é…ç½®ç”¨äºæœåŠ¡å‘ç°ï¼ŒæŒ‡å®šäº† Nacos æœåŠ¡å™¨åœ°å€
      discovery:
        # æœåŠ¡æ³¨å†Œåœ°å€
        server-addr: 49.232.28.14:8848
      # config é…ç½®ç”¨äºä» Nacos è·å–é…ç½®ä¿¡æ¯ï¼ŒåŒæ ·æŒ‡å®šäº† Nacos åœ°å€ï¼Œå¹¶ä¸”è¯´æ˜äº†é…ç½®æ–‡ä»¶çš„æ ¼å¼ä¸º .yml  
      config:
        # é…ç½®ä¸­å¿ƒåœ°å€
        server-addr: 49.232.28.14:8848
        # é…ç½®æ–‡ä»¶æ ¼å¼
        file-extension: yml
        # å…±äº«é…ç½®ï¼šå®šä¹‰äº†è¦ä» Nacos åŠ è½½çš„å…±äº«é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨äº† ${} å ä½ç¬¦æ¥åŠ¨æ€å¼•ç”¨ç¯å¢ƒå˜é‡ï¼Œå³åœ¨å¼€å‘ç¯å¢ƒä¸‹åŠ è½½åä¸º application-dev.yml çš„é…ç½®æ–‡ä»¶ã€‚
        shared-configs:
          - application-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}
    # ç”¨äºæµé‡æ§åˆ¶ã€ç†”æ–­é™çº§å’Œç³»ç»Ÿä¿æŠ¤çš„åº”ç”¨ç»„ä»¶sentinel     
    sentinel:
      # å–æ¶ˆæ§åˆ¶å°æ‡’åŠ è½½
      eager: true
      transport:
        # æŒ‡å®š Sentinel æ§åˆ¶å°åœ°å€
        dashboard: 127.0.0.1:8718
      # nacosé…ç½®æŒä¹…åŒ–
      datasource:
        # ds1 æ˜¯ä¸€ä¸ªæŒ‡å‘ Nacos çš„æ•°æ®æºï¼Œç”¨äºå­˜å‚¨å’Œè¯»å– Sentinel çš„è§„åˆ™é…ç½®
        ds1:
          nacos:
            server-addr: 49.232.28.14:8848
            # dataId å’Œ groupId åˆ†åˆ«è¡¨ç¤ºè§„åˆ™åœ¨ Nacos ä¸­çš„æ ‡è¯†å’Œåˆ†ç»„
            dataId: sentinel-ruoyi-gateway
            groupId: DEFAULT_GROUP
            # data-type å’Œ rule-type æŒ‡å®šäº†è§„åˆ™ç±»å‹ä¸º JSON æ ¼å¼å’Œç½‘å…³æµé‡æ§åˆ¶è§„åˆ™
            data-type: json
            rule-type: gw-flow
```

> å…±äº«é…ç½®å°±æ˜¯ä¸æ­¢ç½‘å…³æ¨¡å—ï¼Œå…¶ä»–æ¨¡å—ä¹Ÿåœ¨ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬ç§°ä¸ºå…±äº«é…ç½®ã€‚ä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªå…±äº«é…ç½®å°±æ˜¯`application-dev.yml`



![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/12.png)

æˆ‘ä»¬ç‚¹å‡»è¯¦æƒ…ï¼Œå¯ä»¥è¿›å»æŸ¥çœ‹

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/13.png)

```yaml
spring:
  # æ’é™¤Druid æ•°æ®æº,å› ä¸ºè‹¥ä¾è‡ªå·±é‡å†™äº†å¤šæ•°æ®æº
  autoconfigure:
    exclude: com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure
  # æŒ‡å®šäº† Spring MVC ä½¿ç”¨ Ant é£æ ¼çš„è·¯å¾„åŒ¹é…å™¨ï¼ˆAntPathMatcherï¼‰ä½œä¸ºè¯·æ±‚æ˜ å°„ç­–ç•¥  
  mvc:
    pathmatch:
      matching-strategy: ant_path_matcher

# feign é…ç½®ï¼š
feign:
  # å¯ç”¨ Sentinel ä¸ Feign çš„é›†æˆï¼ŒSentinel æ˜¯ä¸€ä¸ªå¼€æºçš„ç³»ç»Ÿä¿æŠ¤æ¡†æ¶ï¼Œå¯ä»¥ç”¨äºæµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ç­‰åœºæ™¯
  sentinel:
    enabled: true
  # ä½¿ç”¨ OkHttp ä½œä¸º Feign çš„ HTTP å®¢æˆ·ç«¯ï¼Œè€Œä¸æ˜¯ Apache HttpClient  
  okhttp:
    enabled: true
  httpclient:
    enabled: false
  # è®¾ç½® Feign å®¢æˆ·ç«¯çš„è¿æ¥è¶…æ—¶æ—¶é—´ä¸º 10 ç§’ï¼Œè¯»å–è¶…æ—¶æ—¶é—´ä¹Ÿä¸º 10 ç§’  
  client:
    config:
      default:
        connectTimeout: 10000
        readTimeout: 10000
  # å¯ç”¨äº† Feign è¯·æ±‚å’Œå“åº”çš„å‹ç¼©ï¼Œè¯·æ±‚å‹ç¼©æœ€å°å¤§å°ä¸º 8KBã€‚è¿™æœ‰åŠ©äºå‡å°‘ç½‘ç»œä¼ è¾“çš„æ•°æ®é‡ï¼Œæé«˜ä¼ è¾“æ•ˆç‡      
  compression:
    request:
      enabled: true
      min-request-size: 8192
    response:
      enabled: true

# æš´éœ²ç›‘æ§ç«¯ç‚¹
# Actuator æä¾›äº†ä¸€ç³»åˆ—çš„ç›‘æ§å’Œç®¡ç†ç«¯ç‚¹ï¼Œå¦‚å¥åº·æ£€æŸ¥ã€åº¦é‡æŒ‡æ ‡ã€å®¡è®¡äº‹ä»¶ç­‰ã€‚å°† include è®¾ç½®ä¸º '*' æ„å‘³ç€æ‰€æœ‰ç«¯ç‚¹éƒ½å¯ä»¥é€šè¿‡ Web è®¿é—®ï¼Œè¿™å¯¹äºå¼€å‘å’Œæµ‹è¯•éå¸¸æœ‰ç”¨ï¼Œä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½éœ€è¦æ›´ä¸¥æ ¼çš„è®¿é—®æ§åˆ¶ã€‚
management:
  endpoints:
    web:
      exposure:
        include: '*'
```

### 1.3.1ã€ä¿®æ”¹ruoyi-gateway-dev.yml

1. ä¿®æ”¹`ruoyi-gateway-dev.yml`ï¼Œä¿®æ”¹ redis é…ç½®

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/14.png)

```yaml
spring:
  redis:
    # ä¸»æœºåœ°å€
    host: 49.232.28.14
    # ç«¯å£
    port: 6379
    # å¯†ç 
    password: xxxx
    database: 10
  # é…ç½®äº† Spring Cloud Gateway çš„æœåŠ¡å‘ç°å®šä½å™¨ï¼Œä½¿å…¶èƒ½å¤Ÿä»æ³¨å†Œä¸­å¿ƒNacoså‘ç°å¹¶è·¯ç”±åˆ°æœåŠ¡å®ä¾‹  
  cloud:
    gateway:
      discovery:
        locator:
          # æœåŠ¡ ID å°†è¢«è½¬æ¢ä¸ºå°å†™
          lowerCaseServiceId: true
          # å¯ç”¨è¿™ä¸ªç‰¹æ€§
          enabled: true
      # è®¤è¯ä¸­å¿ƒï¼šæ¯ä¸ª - å¼€å¤´çš„æ¡ç›®å®šä¹‰äº†ä¸€ä¸ªè·¯ç”±è§„åˆ™ï¼ŒåŒ…æ‹¬è·¯ç”±idã€ç›®æ ‡uriã€è·¯ç”±æ¡ä»¶ã€è·¯ç”±è¿‡æ»¤å™¨     
      routes:
        # ruoyi-authè·¯ç”±å°†æ‰€æœ‰ä»¥ /auth/ å¼€å§‹çš„è¯·æ±‚ä»£ç†åˆ°åä¸º ruoyi-auth çš„æœåŠ¡ï¼Œå¹¶ä¸”åº”ç”¨äº†ä¸‰ä¸ªè¿‡æ»¤å™¨ï¼šç¼“å­˜è¯·æ±‚ã€éªŒè¯ç éªŒè¯å’Œå‰ç¼€å‰¥ç¦»
        - id: ruoyi-auth 
          uri: lb://ruoyi-auth
          predicates:
            - Path=/auth/**
          filters:
            # éªŒè¯ç å¤„ç†
            - CacheRequestFilter
            - ValidateCodeFilter
            - StripPrefix=1
        # ä»£ç ç”Ÿæˆ
        - id: ruoyi-gen
          uri: lb://ruoyi-gen
          predicates:
            - Path=/code/**
          filters:
            - StripPrefix=1
        # å®šæ—¶ä»»åŠ¡
        - id: ruoyi-job
          uri: lb://ruoyi-job
          predicates:
            - Path=/schedule/**
          filters:
            - StripPrefix=1
        # ç³»ç»Ÿæ¨¡å—
        - id: ruoyi-system
          uri: lb://ruoyi-system
          predicates:
            - Path=/system/**
          filters:
            - StripPrefix=1
        # æ–‡ä»¶æœåŠ¡
        - id: ruoyi-file
          uri: lb://ruoyi-file
          predicates:
            - Path=/file/**
          filters:
            - StripPrefix=1

# å®‰å…¨é…ç½®
security:
  # éªŒè¯ç å¼€å¯
  captcha:
    enabled: true
    type: math
  # é˜²æ­¢XSSæ”»å‡»
  xss:
    enabled: true
    # æ’é™¤ url
    excludeUrls:
      - /system/notice
  # ä¸æ ¡éªŒç™½åå•ï¼šä¸éœ€è¦èº«ä»½éªŒè¯çš„ URL ç™½åå•
  ignore:
    whites:
      - /auth/logout
      - /auth/login
      - /auth/register
      - /*/v2/api-docs
      - /csrf
```



### 1.3.2ã€å¯åŠ¨RuoYiGatewayApplication.java

å¯åŠ¨`RuoYiGatewayApplication.java` çš„ main æ–¹æ³•å³å¯ã€‚åœ¨Nacosä¸­çš„æœåŠ¡åˆ—è¡¨å¯ä»¥çœ‹åˆ°æœåŠ¡ï¼Œåˆ™è¯´æ˜å¯åŠ¨æˆåŠŸ



![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/15.png)



### 1.3.3ã€å¯åŠ¨æ—¶æ§åˆ¶å°ç»†èŠ‚

å¯åŠ¨æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä»æ‰“å°æ§åˆ¶å°çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯:

```bash
21:12:49.954 [main] INFO  c.a.c.n.r.NacosContextRefresher - [registerNacosListener,129] - [Nacos Config] Listening config: dataId=ruoyi-gateway, group=DEFAULT_GROUP
21:12:49.955 [main] INFO  c.a.c.n.r.NacosContextRefresher - [registerNacosListener,129] - [Nacos Config] Listening config: dataId=ruoyi-gateway.yml, group=DEFAULT_GROUP
21:12:49.955 [main] INFO  c.a.c.n.r.NacosContextRefresher - [registerNacosListener,129] - [Nacos Config] Listening config: dataId=ruoyi-gateway-dev.yml, group=DEFAULT_GROUP
(â™¥â— â€¿â— )ï¾‰ï¾  è‹¥ä¾ç½‘å…³å¯åŠ¨æˆåŠŸ   áƒš(Â´Ú¡`áƒš)ï¾  
 .-------.       ____     __        
 |  _ _   \      \   \   /  /    
 | ( ' )  |       \  _. /  '       
 |(_ o _) /        _( )_ .'         
 | (_,_).' __  ___(_ o _)'          
 |  |\ \  |  ||   |(_,_)'         
 |  | \ `'   /|   `-'  /           
 |  |  \    /  \      /           
 ''-'   `'-'    `-..-'      
```



é…ç½®ä¸­å¿ƒçš„æ•°æ®å®æ—¶å‘å¸ƒï¼Œå¾®æœåŠ¡æ¨¡å—å¯ä»¥æ”¶åˆ°é…ç½®ä¸­å¿ƒçš„æ•°æ®ï¼Œé‚£ä¹ˆç½‘å…³æ¨¡å—å¯ä»¥æ”¶åˆ°å“ªäº›é…ç½®ä¿¡æ¯å‘¢ï¼Ÿä»”ç»†çœ‹å¦‚ä¸‹æ‰“å°ï¼Œæœ‰ä¸‰ä¸ªé…ç½®æ–‡ä»¶å¯ä»¥æ”¶åˆ°:

```bash
Listening config: dataId=ruoyi-gateway, group=DEFAULT_GROUP

Listening config: dataId=ruoyi-gateway.yml, group=DEFAULT_GROUP

Listening config: dataId=ruoyi-gateway-dev.yml, group=DEFAULT_GROUP
```



è¯´æ˜ç½‘å…³æ¨¡å—åœ¨è·å–dataIDä¸º`ruoyi-gateway`ï¼Œgroupä¸º`DEFAULT_GROUP`çš„é…ç½®ä¿¡æ¯ï¼Œå¯ä»¥ç†è§£ä¸ºæ¨ªçºµåæ ‡ï¼Œé€šè¿‡æ¨ªçºµåæ ‡ï¼Œå¯ä»¥æ‰¾åˆ°ç½‘å…³æ¨¡å—å¯ä»¥è·å–åˆ°å¦‚ä¸‹é…ç½®ä¿¡æ¯ï¼š



![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/16.png)

> åœ¨è¿™é‡Œå¯ä»¥å‘ç°ï¼Œè‹¥ä¾å¾ˆç»†èŠ‚ï¼Œå…¶å®å¦‚æœæˆ‘ä»¬ä¸å†™åç¼€ .yml,å…¶å®ç½‘å…³æ¨¡å—ä¹Ÿæ˜¯å¯ä»¥æ”¶åˆ°çš„å“ˆå“ˆå“ˆ







## 1.4ã€è¿è¡Œè®¤è¯Authæ¨¡å—

1. ä¿®æ”¹ä¿®æ”¹`ruoyi-auth`æ¨¡å—ä¸‹çš„ `bootstrap.yml`

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/17.png)

2. ä¿®æ”¹nacosçš„`ruoyi-auth-dev.yml`

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/18.png)

```yaml
spring:
  redis:
    host: 49.232.28.14
    port: 6379
    password: xxxx
    database: 10
```



3. å¯åŠ¨`RuoYiAuthApplication.java` çš„ main æ–¹æ³•å³å¯ã€‚åœ¨Nacosä¸­çš„æœåŠ¡åˆ—è¡¨å¯ä»¥çœ‹åˆ°æœåŠ¡ï¼Œåˆ™è¯´æ˜å¯åŠ¨æˆåŠŸ

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/19.png)

åŒç†ï¼Œé€šè¿‡æ§åˆ¶å°å¯ä»¥çœ‹åˆ°è®¤è¯æ¨¡å—ç›‘å¬çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/20.png)





## 1.5ã€è¿è¡Œç³»ç»ŸSystemæ¨¡å—

1. ä¿®æ”¹`ruoyi-modules/ruoyi-system/src/main/resources/bootstrap.yml`

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/21.png)

2. ä¿®æ”¹`ruoyi-system-dev.yml`

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/22.png)

- ä¿®æ”¹ redis çš„hostã€è´¦å·å¯†ç ã€åŒ…æ‹¬ database
- ä¿®æ”¹ä¸»åº“æ•°æ®æºçš„é“¾æ¥ã€è´¦å·å¯†ç 


```yaml
# springé…ç½®
spring:
  redis:
    host: 49.232.28.14
    port: 6379
    password: First123.
    database: 10
  datasource:
    # druid æœåŠ¡ç›‘æ§çš„è´¦å·å’Œå¯†ç ï¼Œä¹Ÿå°±æ˜¯druidè‡ªå·±çš„æ§åˆ¶å°
    druid:
      stat-view-servlet:
        enabled: true
        loginUsername: admin
        loginPassword: 123456
    # åŠ¨æ€æ•°æ®æº   
    dynamic:
      druid:
        # åˆå§‹åˆ›å»ºçš„è¿æ¥æ•°
        initial-size: 5
        # æœ€å°ç©ºé—²è¿æ¥æ•°
        min-idle: 5
        # æœ€å¤§æ´»åŠ¨è¿æ¥æ•°
        maxActive: 20
        # è·å–è¿æ¥çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œå•ä½æ¯«ç§’
        maxWait: 60000
        # å»ºç«‹è¿æ¥çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’
        connectTimeout: 30000
        # è¯»å–æ•°æ®çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’
        socketTimeout: 60000
        # è¿æ¥ç©ºé—²æ£€æŸ¥çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ¯«ç§’
        timeBetweenEvictionRunsMillis: 60000
        # è¿æ¥ç©ºé—²å¤šä¹…åå¯è¢«é©±é€ï¼Œå•ä½æ¯«ç§’
        minEvictableIdleTimeMillis: 300000
        # ç”¨äºéªŒè¯è¿æ¥æœ‰æ•ˆæ€§çš„SQLè¯­å¥
        validationQuery: SELECT 1 FROM DUAL
        # å½“è¿æ¥ç©ºé—²æ—¶è¿›è¡ŒéªŒè¯
        testWhileIdle: true
        # å½“ä»è¿æ¥æ± è·å–è¿æ¥æ—¶è¿›è¡ŒéªŒè¯
        testOnBorrow: false
        # å½“è¿æ¥è¿”å›è¿æ¥æ± æ—¶è¿›è¡ŒéªŒè¯
        testOnReturn: false
        # æ˜¯å¦ç¼“å­˜PreparedStatement
        poolPreparedStatements: true
        # æ¯ä¸ªè¿æ¥ç¼“å­˜çš„PreparedStatementæ•°é‡
        maxPoolPreparedStatementPerConnectionSize: 20
        # Druidæä¾›çš„è¿‡æ»¤å™¨ï¼Œä¾‹å¦‚ç»Ÿè®¡å’Œæ—¥å¿—è®°å½•
        filters: stat,slf4j
        # Druidçš„è¿æ¥å±æ€§ï¼ŒåŒ…æ‹¬åˆå¹¶SQLå’Œæ…¢SQLçš„é˜ˆå€¼
        connectionProperties: druid.stat.mergeSql\=true;druid.stat.slowSqlMillis\=5000
      datasource:
          # ä¸»åº“æ•°æ®æº
          master:
            driver-class-name: com.mysql.cj.jdbc.Driver
            url: jdbc:mysql://49.232.28.14:3306/kuangstudy_cloud?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
            username: kuangstudy_cloud
            password: 123456
          # ä»åº“æ•°æ®æº
          # slave:
            # username: 
            # password: 
            # url: 
            # driver-class-name: 

# mybatisé…ç½®
mybatis:
    # æœç´¢æŒ‡å®šåŒ…åˆ«å
    typeAliasesPackage: com.ruoyi.system
    # é…ç½®mapperçš„æ‰«æï¼Œæ‰¾åˆ°æ‰€æœ‰çš„mapper.xmlæ˜ å°„æ–‡ä»¶
    mapperLocations: classpath:mapper/**/*.xml

# swaggeré…ç½®
swagger:
  title: ç³»ç»Ÿæ¨¡å—æ¥å£æ–‡æ¡£
  license: Powered By ruoyi
  licenseUrl: https://ruoyi.vip
```



> è§£é‡Šä¹‹å‰ä¸ºä»€ä¹ˆè¦æ’é™¤Druidï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬è‡ªå·±å†™äº†åŠ¨æ€æ•°æ®æº dynamicï¼Œç„¶åç”¨äº†Druidï¼Œåˆåˆ†ä¸ºä¸»ä»åº“

3. è¿è¡Œ`RuoYiSystemApplication.java`çš„mainæ–¹æ³•

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/23.png)

åŒç†ï¼Œé€šè¿‡æ§åˆ¶å°å¯ä»¥çœ‹åˆ°ç³»ç»Ÿæ¨¡å—ç›‘å¬çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/24.png)





## 1.6ã€è¿è¡Œå‰ç«¯

è¿™æ ·å¿…é¡»è¿è¡Œçš„æ¨¡å—éƒ½è¿è¡Œå®Œæˆäº†ï¼Œå…¶ä»–æ¨¡å—æš‚æ—¶å¯ä»¥ä¸ç”¨ç®¡ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¿è¡Œå‰ç«¯



1. æ‹‰å–ä¾èµ–

```bash
npm i

# æˆ–è€…ï¼ˆæ¨èï¼‰
pnpm i
```

2. åœ¨ package.json ä¸­è¿è¡Œ dev

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/25.png)



å¤§åŠŸå‘Šæˆï¼æˆ‘ä»¬è¿™ä¸ªæ—¶å€™å¯ä»¥ä¸ç™»é™†ï¼Œç›´æ¥å»çœ‹redisä¸­çš„æ•°æ®ï¼

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/26.png)

è¿™ä¸ªå°±è·Ÿå‰åç«¯åˆ†ç¦»ç‰ˆæœ¬ä¸²èµ·æ¥äº†ï¼æ»¡æ»¡çš„ç†Ÿæ‚‰æ„Ÿå§å“ˆå“ˆå“ˆï¼ä¹‹åå°±å¯ä»¥å¥”æ”¾ç©å•¦ï¼







## 1.7ã€å‰åç«¯ç›®å½•ç»“æ„

### 1.7.1ã€åç«¯ç»“æ„

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/27.png)



å¾®æœåŠ¡ç‰ˆæœ¬è‹¥ä¾æ²¡æœ‰ç”¨Spring Security æ¡†æ¶ï¼Œè€Œæ˜¯è‡ªå·±å†™äº†ä¸€å¥—å®‰å…¨æ¡†æ¶ã€‚



### 1.7.2ã€å‰ç«¯ç»“æ„

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/28.png)



### 1.7.3ã€æ ¸å¿ƒæŠ€æœ¯

> [!NOTE]
>
> - å‰ç«¯æŠ€æœ¯æ ˆ ES6ã€vueã€vuexã€vue-routerã€vue-cliã€axiosã€element-ui
> - åç«¯æŠ€æœ¯æ ˆ Spring Bootã€Spring Cloud & Alibabaã€Nacosã€Sentinel



# 2ã€æœåŠ¡ç½‘å…³



## 2.1ã€å¾®æœåŠ¡æ¶æ„å›¾

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/å¾®æœåŠ¡åŸºç¡€æ¶æ„.png)



ğŸ”¥ğŸ”¥ğŸ”¥æµè§ˆå™¨å‘ç”ŸAPIçš„è°ƒç”¨ï¼Œè°ƒç”¨çš„æ—¶å€™å¯ä»¥ä½¿ç”¨Nginxè¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œè¿›å…¥ç½‘å…³gatewayé›†ç¾¤ï¼Œä¾‹å¦‚å¦‚ä¸‹é…ç½®ï¼šç½‘å…³æ ¹æ®æˆ‘ä»¬çš„urlè·¯å¾„ï¼Œåˆ¤æ–­è¿›å…¥å“ªä¸ªå¾®æœåŠ¡ï¼Œæ¯”å¦‚ï¼šè®¿é—®çš„è·¯å¾„æ˜¯`/auth/**`æ‰“å¤´çš„ï¼Œé‚£ä¹ˆç½‘å…³å°±å°†è¯·æ±‚è´Ÿè½½å‡è¡¡é€å…¥`lb://ruoyi-auth`å¾®æœåŠ¡ï¼Œlbå°±æ˜¯è´Ÿè½½å‡è¡¡ï¼Œå¹¶ä¸”å¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤å’Œå¤„ç†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯`StripPrefix=1`ï¼Œä¼šæŠŠè¯·æ±‚çš„`/auth`å‰ç¼€å»æ‰ï¼Œé‚£ä¹ˆè¯·æ±‚çš„å°±ä¼šæ˜¯`/**`åé¢çš„urläº†ã€‚

```yaml
spring:
 cloud:
  routes:
   # è®¤è¯ä¸­å¿ƒ
    - id: ruoyi-auth
      uri: lb://ruoyi-auth
      predicates:
        - Path=/auth/**
      filters:
        # éªŒè¯ç å¤„ç†
        - CacheRequestFilter
        - ValidateCodeFilter
        - StripPrefix=1
```



åƒä¸Šé¢é…ç½®çš„ filters è¿‡æ»¤å™¨æœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«æ˜¯éªŒè¯ç ã€æ ¡éªŒç ã€å‰ç¼€å»é™¤è¿‡æ»¤å™¨ã€‚å…¶ä¸­å‰ç¼€å»é™¤StripPrefixè¿‡æ»¤å™¨æ˜¯SpringCloudè‡ªå¸¦çš„ï¼ŒSpringCloudè‡ªå¸¦çš„è¿‡æ»¤å™¨æœ‰å¾ˆå¤šï¼Œ[è¿›å…¥æŸ¥çœ‹](#2.3ã€è¿‡æ»¤å™¨)

- å¹¶ä¸”è¿™ç§é…ç½®åœ¨ä¸€ä¸ªè·¯ç”±ä¸‹çš„ filters æ˜¯å±€éƒ¨è¿‡æ»¤å™¨ï¼Œåªå¯¹è¿™ä¸ªè·¯ç”±ä¸‹çš„è¯·æ±‚ç”Ÿæ•ˆ



## 2.2ã€è·¯ç”±åˆ†å‘å…·ä½“ç­–ç•¥

```yaml
spring:
  redis:
    host: 49.232.28.14
    port: 6379
    password: xxx
    database: 10
  cloud:
    gateway:
      discovery:
        locator:
          lowerCaseServiceId: true
          enabled: true
      routes:
        # è®¤è¯ä¸­å¿ƒ
        - id: ruoyi-auth
          uri: lb://ruoyi-auth
          predicates:
            - Path=/auth/**
          filters:
            # éªŒè¯ç å¤„ç†
            - CacheRequestFilter
            - ValidateCodeFilter
            - StripPrefix=1
        # ä»£ç ç”Ÿæˆ
        - id: ruoyi-gen
          uri: lb://ruoyi-gen
          predicates:
            - Path=/code/**
          filters:
            - StripPrefix=1
        # å®šæ—¶ä»»åŠ¡
        - id: ruoyi-job
          uri: lb://ruoyi-job
          predicates:
            - Path=/schedule/**
          filters:
            - StripPrefix=1
        # ç³»ç»Ÿæ¨¡å—
        - id: ruoyi-system
          uri: lb://ruoyi-system
          predicates:
            - Path=/system/**
          filters:
            - StripPrefix=1
        # æ–‡ä»¶æœåŠ¡
        - id: ruoyi-file
          uri: lb://ruoyi-file
          predicates:
            - Path=/file/**
          filters:
            - StripPrefix=1

# å®‰å…¨é…ç½®
security:
  # éªŒè¯ç 
  captcha:
    enabled: true
    type: math
  # é˜²æ­¢XSSæ”»å‡»
  xss:
    enabled: true
    excludeUrls:
      - /system/notice
  # ä¸æ ¡éªŒç™½åå•
  ignore:
    whites:
      - /auth/logout
      - /auth/login
      - /auth/register
      - /*/v2/api-docs
      - /csrf
```



Spring Cloud Gatewayé…ç½®

- `routes`ï¼šå®šä¹‰ Spring Cloud Gatewayçš„è·¯ç”±è§„åˆ™
- `id: ruoyi-auth`ï¼š è·¯ç”±è§„åˆ™çš„IDï¼Œç”¨äºæ ‡è¯†è¯¥è·¯ç”±è§„åˆ™
- `uri: lb://ruoyi-auth`ï¼šè·¯ç”±çš„ç›®æ ‡åœ°å€ï¼Œä½¿ç”¨è´Ÿè½½å‡è¡¡çš„æ–¹å¼è®¿é—®`ruoyi-auth`æœåŠ¡
  - lb ï¼š load balance è´Ÿè½½å‡è¡¡
- `predicates`ï¼š å®šä¹‰è·¯ç”±è§„åˆ™çš„åŒ¹é…æ¡ä»¶
  - `- Path=/auth/**` ï¼šè¯·æ±‚è·¯å¾„åŒ¹é…è§„åˆ™ï¼Œè¡¨ç¤ºæ‰€æœ‰ä»¥`/auth/`å¼€å¤´çš„è¯·æ±‚
- `filters`ï¼šå®šä¹‰è¿‡æ»¤å™¨ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè¿‡æ»¤å’Œå¤„ç†
  - `- CacheRequestFilter`ï¼šç¼“å­˜è¯·æ±‚çš„è¿‡æ»¤å™¨
  - `- ValidateCodeFilter`ï¼š éªŒè¯ç éªŒè¯è¿‡æ»¤å™¨
  - `- StringPrefix=1`ï¼šç§»é™¤è¯·æ±‚è·¯å¾„ä¸­çš„`/auth`å‰ç¼€







## 2.3ã€è¿‡æ»¤å™¨å·¥å‚

GatewayFilteræ˜¯ç½‘å…³ä¸­æä¾›çš„ä¸€ç§è¿‡æ»¤å™¨ï¼Œå¯ä»¥å¯¹è¿›å…¥ç½‘å…³çš„è¯·æ±‚å’Œå¾®æœåŠ¡è¿”å›çš„å“åº”åšå¤„ç†ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/29.png)

åœ¨è¿‡æ»¤å™¨è¿™é‡Œå¯å‚è€ƒï¼š[SpringCloudè¿‡æ»¤å™¨å·¥å‚](https://blog.csdn.net/Augenstern_QXL/article/details/139129353?spm=1001.2014.3001.5502)







### 2.3.1ã€å…¨å±€è¿‡æ»¤å™¨











## 2.4ã€æ–­è¨€å·¥å‚

- è¿™é‡Œæˆ‘ä¹‹å‰çš„ç¬”è®°ä¹Ÿæœ‰è®°å½•ï¼š[SpringCloudæ–­è¨€å·¥å‚](https://blog.csdn.net/Augenstern_QXL/article/details/139129353?spm=1001.2014.3001.5502)





# 3ã€ä¸šåŠ¡é€»è¾‘

## 3.1ã€è¢«å®šä½è‡³ç™»å½•

å½“æˆ‘ä»¬è¯·æ±‚`localhost:80`ä¹Ÿå°±æ˜¯ç›¸å½“äºè¯·æ±‚pathä¸ºç©ºï¼Œä¼šè¢«é‡å®šå‘åˆ° index é¦–é¡µï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯è¿›å…¥çš„ç™»å½•loginé¡µé¢ï¼Œä¸ºä»€ä¹ˆä¼šè¿™æ ·å‘¢ï¼Ÿ

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/30.png)

- å®é™…ä¸Šæ˜¯å‰ç«¯çš„å‰ç½®è·¯ç”±ä¼šå»åˆ¤æ–­æ­¤æ¬¡è¯·æ±‚æ˜¯å¦æºå¸¦äº† tokenï¼Œå¦‚æœæ²¡å¸¦ä¸”ä¸åœ¨ç™½åå•å†…ï¼Œåˆ™ä¼šé‡å®šå‘è‡³ç™»å½•é¡µé¢

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/31.png)

## 3.2ã€è®°ä½å¯†ç é€»è¾‘

è®°ä½å¯†ç è‹¥ä¾æ˜¯ä»€ä¹ˆé€»è¾‘å‘¢ï¼Ÿåœ¨`login.vue`é‡Œé¢å¯ä»¥çœ‹åˆ°ï¼Œè¿›å…¥é¡µé¢ä¼šæ‰§è¡Œ`getCookie`æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å‡å¦‚ç‚¹å‡»äº†è®°ä½å¯†ç ï¼Œé‚£ä¹ˆé¦–å…ˆä¼šä»Cookieé‡Œé¢å»æ‰¾usernameå’Œpasswordã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/32.png)



è€Œä¸”æˆ‘ä»¬çš„è´¦å·å¯†ç é»˜è®¤å¡«å……çš„ï¼Œä¹Ÿæ˜¯åœ¨dataæ•°æ®ä¸‹å°±å¯ä»¥æ‰¾åˆ°ã€‚

![=](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/33.png)



## 3.3ã€dev-api

æ‰“å¼€F12æˆ‘ä»¬ä¼šå‘ç°å‰ç«¯åœ¨è°ƒç”¨APIçš„æ—¶å€™ï¼Œä¼šå¸¦ä¸€ä¸ª`/dev-api`çš„urlï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæ˜¯å› ä¸ºè‹¥ä¾åœ¨å°è£…axiosçš„æ—¶å€™ï¼Œä¼šé…ç½®ä¸€ä¸ªbaseURLçš„å­—æ®µï¼Œè¡¨ç¤ºè¯·æ±‚URLçš„å…¬å…±éƒ¨åˆ†ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/34.png)

å‰ç«¯ä½¿ç”¨çš„æ˜¯80ç«¯å£ï¼Œåç«¯ä½¿ç”¨çš„æ˜¯8080ç«¯å£ï¼Œå¼€å‘ç¯å¢ƒä¼šåœ¨æœ¬åœ°å¯¹è¯·æ±‚çš„ URL è¿›è¡Œæ‹¦æˆªï¼Œæ‹¦æˆªå¦‚ä¸‹ï¼š

- `http://localhost/dev-api/**` ä¼šè¢«æ‹¦æˆªå¹¶å¤„ç†æˆ`http://localhost:8080/**`
- 8080ä¹Ÿå°±æ˜¯åç«¯ç½‘å…³æ¨¡å—çš„ç«¯å£

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/35.png)



```javascript
  // webpack-dev-server ç›¸å…³é…ç½®
  devServer: {
    // è®©ä½ çš„æœåŠ¡å™¨å¯ä»¥è¢«å¤–éƒ¨è®¿é—®
    host: '0.0.0.0',
    // æŒ‡å®šç›‘å¬è¯·æ±‚çš„ç«¯å£å·
    port: port,
    // å‘Šè¯‰ dev-server åœ¨æœåŠ¡å™¨å·²ç»å¯åŠ¨åæ‰“å¼€æµè§ˆå™¨ã€‚è®¾ç½®å…¶ä¸º true ä»¥æ‰“å¼€ä½ çš„é»˜è®¤æµè§ˆå™¨
    open: true,
    // å¯ç”¨ä»£ç†
    proxy: {
      // å½“æ˜¯process.env.VUE_APP_BASE_APIä¹Ÿå°±æ˜¯ '/dev-api' çš„urlæ—¶,å°†ä»£ç†è½¬åˆ° http://localhost:8080
      // å³å¯¹äº'/dev-api/**'çš„è¯·æ±‚ä¼šå°†è¯·æ±‚ä»£ç†åˆ° http://localhost:8080/dev-api/**
      [process.env.VUE_APP_BASE_API]: {
        target: `http://localhost:8080`,
        // é»˜è®¤æƒ…å†µä¸‹ï¼Œä»£ç†æ—¶ä¼šä¿ç•™ä¸»æœºå¤´çš„æ¥æºï¼Œå¯ä»¥å°† changeOrigin è®¾ç½®ä¸º true ä»¥è¦†ç›–æ­¤è¡Œä¸º
        changeOrigin: true,
        // é‡å†™è·¯å¾„,å°† process.env.VUE_APP_BASE_APIä¹Ÿå°±æ˜¯ '/dev-api' æ¢ä¸ºç©º
        pathRewrite: {
          ['^' + process.env.VUE_APP_BASE_API]: ''
        }
      }
    },
    disableHostCheck: true
  },
```





> [!note]
>
> å…³äºdevServerçš„é…ç½®å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š[devServer](https://webpack.docschina.org/configuration/dev-server/#devserverhost)







## 3.4ã€éªŒè¯ç 

åœ¨ä¹‹å‰æˆ‘ä»¬çœ‹åˆ° redis å¾®æœåŠ¡æ¯”åˆ†ç¦»ç‰ˆæœ¬ä¼šå¤šå­˜ä¸€ä¸ª`captcha_codes`çš„é”®å€¼å¯¹

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/26.png)



å…¶å®å®ƒæ˜¯å­˜äº†ä¸€ä¸ªå‰ç¼€:uuidçš„`captcha_codes:uuid`çš„é”®ï¼Œå€¼ä¸ºéªŒè¯ç çš„ç­”æ¡ˆï¼Œæ‰€ä»¥KVå°±æ˜¯é”®å€¼å¯¹ã€‚åœ¨ç‚¹å‡»ç™»å½•çš„æ—¶å€™ï¼Œå‰åä¼šå°†è¿™ä¸ªuuidä¼ ç»™åç«¯ï¼Œåç«¯å°±å¯ä»¥æ ¹æ®`å‰ç¼€:uuid`ä»redisä¸­æ‰¾åˆ°æ‰€å¯¹åº”çš„ç­”æ¡ˆï¼Œä¸æˆ‘ä»¬è¾“å…¥çš„éªŒè¯ç ç­”æ¡ˆè¿›è¡Œæ¯”å¯¹ã€‚







## 3.5ã€ç™»å½•

æ•´ä½“è€Œè¨€ï¼Œå‰ç«¯æ”¶é›†è¡¨å•ï¼Œå››ä¸ªå†…å®¹ï¼šuuidã€éªŒè¯ç ç­”æ¡ˆã€ç”¨æˆ·åã€å¯†ç ï¼Œå°†å…¶ä¼ å…¥åç«¯è¿›è¡Œè®¤è¯æ“ä½œã€‚

> uuid å…¶å®æ˜¯åœ¨è¿›å…¥ç™»å½•é¡µé¢çš„æ—¶å€™ï¼Œä¼šå‘redisä¸­å­˜ä¸€ä¸ª`captcha_codes:uuid`çš„Kï¼ŒéªŒè¯ç ç­”æ¡ˆä¸ºVã€‚

åç«¯æŸ¥è¯¢æ•°æ®åº“ï¼ŒæŸ¥è¯¢åˆ°ç”¨æˆ·ä¹‹åï¼ŒæŠŠç”¨æˆ·ä¿¡æ¯æ”¾å…¥ Redis ä¸­ï¼ŒåŒæ—¶ç”Ÿæˆä¸€ä¸ª token ç»™å‰ç«¯ï¼Œä¹‹åå‰ç«¯éœ€è¦è¯·æ±‚åç«¯APIçš„æ—¶å€™ï¼Œæ¯æ¬¡éƒ½éœ€è¦æ‹¿ç€ tokenï¼Œé”®æ˜¯`login_tokens: + å½“å‰çš„tokenId`ï¼ŒtokenIdæ˜¯ä¸€ä¸ªuuidï¼Œå€¼æ˜¯ç”¨æˆ·çš„å„ç§ä¿¡æ¯,è¿™æ ·ä¸‹æ¬¡ç”¨æˆ·å¸¦ç€tokenæ¥çš„æ—¶å€™ï¼Œåç«¯å¯ä»¥æ ¹æ® tokenId æ¥ redis ä¸­åŒ¹é…ã€‚ï¼ˆå–è‡ªè‹¥ä¾åˆ†ç¦»ç‰ˆç¬”è®°ï¼‰



### 3.5.1ã€ç™»å½•å‰ç«¯

åœ¨ç™»å½•çš„æ—¶å€™ä¼šè°ƒç”¨`handleLogin()`æ–¹æ³•ï¼Œè¿™é‡Œå¤ä¹ ä¸€ä¸‹ï¼Œåœ¨æ ‡ç­¾ä¸­åŠ äº†`ref="loginForm"`,å°±å¯ä»¥åœ¨æ–¹æ³•ä¸­é€šè¿‡`this.$refs.loginForm`æ¥è·å–DOMï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯è·å–åˆ° `<el-form></el-form>`ã€‚

é€šè¿‡ validate è¿›è¡ŒéªŒè¯ï¼Œå¦‚æœ`this.loginForm.rememberMe`ä¸ºtrueï¼Œä¹Ÿå°±æ˜¯å‹¾é€‰äº†è®°ä½æˆ‘ï¼Œé‚£ä¹ˆå°±å…ˆä» Cookie ä¸­è·å–ç”¨æˆ·åå’Œå¯†ç ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/36.png)

å¦‚æœæœªå‹¾é€‰è®°ä½æˆ‘ï¼Œåˆ™ä¼šé€šè¿‡`this.$store.dispatch`è§¦å‘ action çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥ `this.loginForm` å¯¹è±¡å‚æ•°ï¼Œä¹‹åå¯¼èˆªåˆ°`this.redirect`æŒ‡å®šçš„è·¯å¾„ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šåˆ™å¯¼èˆªåˆ°æ ¹è·¯å¾„`"/"`ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/37.png)

actions çš„æ–¹æ³•å¦‚ä¸‹ï¼š

```javascript
actions: {
    // ç™»å½•
    Login({ commit }, userInfo) {
      // ä»userInfoå¯¹è±¡ä¸­æå–username, password, éªŒè¯ç ç­”æ¡ˆcodeå’Œuuidå­—æ®µ
      const username = userInfo.username.trim()
      const password = userInfo.password
      const code = userInfo.code
      const uuid = userInfo.uuid
      //è¿”å›ä¸€ä¸ªæ–°çš„Promiseï¼Œä»¥ä¾¿å¤„ç†å¼‚æ­¥æ“ä½œ
      return new Promise((resolve, reject) => {
        login(username, password, code, uuid).then(res => {
          let data = res.data
          //è®¾ç½®å…¨å±€çš„token
          setToken(data.access_token)
          //åœ¨Vuex storeä¸­æäº¤ä¸€ä¸ªactionæ¥æ›´æ–°token
          commit('SET_TOKEN', data.access_token)
          //è®¾ç½®è¿‡æœŸæ—¶é—´
          setExpiresIn(data.expires_in)
          //æ›´æ–°Vuex storeä¸­çš„è¿‡æœŸæ—¶é—´
          commit('SET_EXPIRES_IN', data.expires_in)
          // è§£æPromiseï¼Œè¡¨ç¤ºç™»å½•æˆåŠŸ
          resolve()
        }).catch(error => {
          //æ•è·loginå‡½æ•°ä¸­å¯èƒ½æŠ›å‡ºçš„é”™è¯¯ï¼Œå¹¶æ‹’ç»Promise
          reject(error)
        })
      })
    },
}
```

- `Login`å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä¸€ä¸ªåŒ…å«`commit`æ–¹æ³•çš„å¯¹è±¡ï¼Œè¿™æ˜¯Vuexæä¾›çš„ç”¨äºæ”¹å˜storeçŠ¶æ€çš„æ–¹æ³•ã€‚ç¬¬äºŒä¸ªå‚æ•°`userInfo`æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«äº†ç™»å½•æ‰€éœ€çš„ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·åã€å¯†ç ã€éªŒè¯ç ç­”æ¡ˆcodeå’ŒUUID
- ä½¿ç”¨`new Promise`åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„Promiseå¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨å¼‚æ­¥æ“ä½œå®Œæˆåé€šè¿‡`resolve`æˆ–`reject`æ¥å¤„ç†ç»“æœã€‚
- `login`å‡½æ•°æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œå®ƒæ¥æ”¶ç™»å½•ä¿¡æ¯å¹¶è¿”å›ä¸€ä¸ªPromiseã€‚å½“è¿™ä¸ªPromiseè§£ææ—¶ï¼Œä¼šå¤„ç†æœåŠ¡å™¨å“åº”ï¼Œæå–æ•°æ®å¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚
- ä½¿ç”¨`commit`æ–¹æ³•æäº¤ä¸¤ä¸ªmutationâ€”â€”`SET_TOKEN`å’Œ`SET_EXPIRES_IN`ï¼Œè¿™ä¼šæ›´æ–°Vuex storeä¸­çš„çŠ¶æ€

### 3.5.2ã€è¡¨å•æ ¡éªŒ

è¿™é‡Œå†å¤ä¹ ä¸€ä¸‹è¡¨å•æ ¡éªŒ

1. åœ¨ form è¡¨å•åŠ  `:rules="loginRules"`
2. åœ¨el-form-itemé‡Œé¢æ·»åŠ propï¼Œpropå¯¹åº” v-model="loginForm" çš„ loginForm çš„å±æ€§
3. åœ¨ data é‡Œé¢æ·»åŠ å±æ€§ `loginRules`
4. åœ¨ç‚¹å‡»æäº¤çš„æŒ‰é’®é‡Œé¢ `validate` æ ¡éªŒï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–¹çš„`this.$refs.loginForm.validate`

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/38.png)

### 3.5.3ã€ç™»å½•åç«¯

æ€»ç»“ï¼šåœ¨ç‚¹å‡»ç™»å½•æŒ‰é’®çš„æ—¶å€™ï¼Œè¯·æ±‚è·¯å¾„ä¸º`http://localhost/dev-api/auth/login`ï¼Œè¯·æ±‚æ–¹å¼æ˜¯ POSTï¼Œå‰ç«¯ä¼šå°†è¯·æ±‚ä»£ç†è½¬åˆ°`http://localhost:8080`,åŒæ—¶ä¼šæŠŠ dev-api å‰ç¼€ç»™å¹²æ‰ï¼Œæœ€åè¯·æ±‚åç«¯å®é™…çš„ url æ˜¯ `http://localhost:8080/auth/login`



è¿™æ ·çš„è¯·æ±‚è¿›å…¥ç½‘å…³ï¼Œè·¯å¾„ä¸º `/auth/**` å¼€å¤´çš„è¯·æ±‚è¢«æ³¨å†Œä¸­å¿ƒ nacos è´Ÿè½½å‡è¡¡æ‰“å…¥å¾®æœåŠ¡ ruoyi-auth ä¸­ï¼Œå¹¶ä¸”ç»è¿‡ä¸‰ä¸ªå±€éƒ¨è¿‡æ»¤å™¨ï¼Œå¦‚ä¸‹å›¾ï¼š

- CacheRequestFilterï¼šè·å– body è¯·æ±‚æ•°æ®(è§£å†³æµä¸èƒ½é‡å¤è¯»å–é—®é¢˜)
- ValidateCodeFilterï¼šéªŒè¯ç æ ¡éªŒè¿‡æ»¤å™¨ï¼Œç”¨äºæ ¡éªŒéªŒè¯ç è¾“å…¥å¯¹ä¸å¯¹
- StripPrefixï¼šå»æ‰æœ€å‰é¢çš„ä¸€çº§è·¯å¾„å‰ç¼€

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/39.png)



è¿™é‡Œæˆ‘ä»¬æ¥Debugï¼ŒDebugä¹‹å‰å…ˆå»å…±äº«é…ç½®`application-dev.yml`é‡Œé¢æ”¹ä¸ªè¶…æ—¶æ—¶é—´ï¼š

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/40.png)



åˆ†åˆ«ä»¥Debugçš„æ–¹å¼å¯åŠ¨ Authã€Gatewayã€Systemå¾®æœåŠ¡ï¼Œå¹¶ä¸”åœ¨è¿‡æ»¤å™¨ä¸Šåˆ†åˆ«æ‰“ä¸Šæ–­ç‚¹ï¼Œèµ°å®ŒGatewayæ¨¡å—åï¼Œä¼šå»è¿œç¨‹è°ƒç”¨Authé‰´æƒæ¨¡å—çš„`/login`



#### 1ã€éªŒè¯ç è¿‡æ»¤å™¨

æˆ‘ä»¬ç‚¹å‡»ç™»å½•ï¼Œä¼šå»è°ƒç”¨`/auth/login`æ¥å£ï¼Œ

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/41.png)

åœ¨åç«¯çœ‹ç¼“å­˜è¯·æ±‚è¿‡æ»¤å™¨CacheRequestFilterï¼Œè¿™ä¸ªè¿‡æ»¤å™¨ä¸»è¦æ˜¯è·å–bodyè¯·æ±‚æ•°æ®ï¼Œå¹¶ä¸”è§£å†³æµä¸èƒ½é‡å¤è¯»å–çš„é—®é¢˜ï¼š

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/42.png)

ä»è¿™é‡Œæ˜¯å¯ä»¥çœ‹åˆ°è¿‡æ»¤å™¨é“¾æ¡ï¼Œå¯ä»¥å‘ç°`order`çš„å€¼è¶Šå°ï¼Œé‚£ä¹ˆå®ƒä¼˜å…ˆçº§è¶Šé«˜ï¼Œé€šè¿‡ç¼“å­˜è¯·æ±‚è¿‡æ»¤å™¨CacheRequestFilterè·å–bodyæ•°æ®ï¼Œä¹‹åå†è¿›å…¥ValidateCodeFilteréªŒè¯ç è¿‡æ»¤å™¨ï¼Œå¹¶ä¸”æˆ‘ä»¬çš„å…¨å±€è¿‡æ»¤å™¨AuthFilterã€XssFilterçš„çš„orderæ˜¯ -200ã€-100ã€‚

ä¹‹åæˆ‘ä»¬è¿›å…¥`ValidateCodeFilter`éªŒè¯ç è¿‡æ»¤å™¨ï¼Œindexæ˜¾ç¤ºçš„æ˜¯10ï¼Œä¹Ÿå°±æ˜¯èµ°çš„æ˜¯ç¬¬10ä¸ªè¿‡æ»¤å™¨ï¼Œä¸‹æ ‡ä¸º9ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/43.png)



`ValidateCodeFilter`éªŒè¯ç è¿‡æ»¤å™¨çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆæ‹¿åˆ°æˆ‘ä»¬è¯·æ±‚çš„URLï¼Œçœ‹çœ‹è¯·æ±‚æ˜¯ä¸æ˜¯/auth/login æˆ–è€… /auth/registerï¼Œå¦‚æœä¸æ˜¯åˆ™ä¸ä½œå¤„ç†ï¼Œé€€å‡ºè¿‡æ»¤å™¨ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/44.png)

å¦‚æœæ˜¯æ³¨å†Œæˆ–è€…ç™»å½•ï¼Œé‚£ä¹ˆå°±è¦è¿›è¡ŒéªŒè¯ç è¿‡æ»¤å™¨ï¼Œé¦–å…ˆè·å–åˆ°è¯·æ±‚ä½“ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å‰ç«¯ä¼ çš„å››ä¸ªå‚æ•°ï¼Œåœ¨è¿™é‡Œè¢«è·å–åˆ°äº†ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/45.png)

`JSON.parseObject(rspStr)`ä¹Ÿå°±æ˜¯å°†Stringè½¬ä¸ºä¸€ä¸ªHashMapï¼Œé”®å€¼å¯¹ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/46.png)

æœ€åæœ¬åœ°è°ƒç”¨`validateCodeService`æ¥checkCaptchaæ ¡éªŒéªŒè¯ç ï¼Œä¹Ÿå°±æ˜¯è·å–åˆ°éªŒè¯ç ç­”æ¡ˆå’Œuuidï¼Œä¹‹åè‚¯å®šæ˜¯å»redisé‡Œé¢æŸ¥è¯¢ï¼Œæ ¹æ®`captcha_codes:uuid`ä¸ºé”®æ¥æŸ¥è¯¢å€¼ï¼Œå¦‚æœå’Œç­”æ¡ˆä¸€è‡´åˆ™é€šè¿‡ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/47.png)



#### 2ã€ç™»å½•é€»è¾‘

ä¸Šé¢çš„è¿‡æ»¤å™¨èµ°å®Œåå°±ä¼šå»è°ƒç”¨å…¶ä»–å¾®æœåŠ¡äº†ï¼Œè°ƒç”¨çš„æ˜¯é‰´æƒæ¨¡å—authçš„`/login`ç™»å½•æ¥å£ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/48.png)

`sysLoginService.login`æ–¹æ³•å¦‚ä¸‹ï¼š

- æ–¹æ³•é‡Œé¢å¯¹ç”¨æˆ·åå’Œå¯†ç æœ‰æœ€å¤§é•¿åº¦å’Œæœ€å°é•¿åº¦é™åˆ¶ï¼Œåœ¨`UserConstants.java`ç±»é‡Œé¢
- åŒæ—¶åœ¨redisä¸­å­˜æœ‰IPé»‘åå•

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/49.png)

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/50.png)

ä¸Šé¢çš„åˆ¤æ–­æ¡ä»¶èµ°å®Œä¹‹åï¼Œå°±çœŸæ­£å¼€å§‹è°ƒç”¨è¿œç¨‹æœåŠ¡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯äº†ï¼Œ`remoteUserService.getUserInfo`ï¼Œè€Œ`remoteUserService`æ˜¯ruoyi-apiæ¨¡å—ä¸‹çš„ï¼Œè¿™é‡Œå¤ä¹ ä¸€ä¸‹ï¼Œå‡­ä»€ä¹ˆ ruoyi-auth æ¨¡å—å¯ä»¥è°ƒç”¨ ruoyi-api ä¸‹çš„æ–¹æ³•?

- æ˜¯å› ä¸º auth æ¨¡å—å¼•å…¥äº† ruoyi-api æ¨¡å—ä¾èµ–

æˆ‘ä»¬å¯ä»¥å‘ç°`remoteUserService`ä¸Šæ–¹åŠ äº†æ³¨è§£`@Autowired`ï¼Œè¯´æ˜è¿™ä¸ªæ¥å£æ˜¯åœ¨Springå®¹å™¨é‡Œé¢ï¼Œå®ƒå‡­ä»€ä¹ˆåœ¨Springå®¹å™¨é‡Œé¢å‘¢ï¼Ÿæ˜¯å› ä¸ºåŠ äº†`@FeignClient`æ³¨è§£

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/51.png)



è¿™ä¸ªæ³¨è§£ä¸ºä»€ä¹ˆå¯ä»¥ç”Ÿæ•ˆå‘¢ï¼Ÿæ˜¯å› ä¸º ruoyi-auth çš„å¯åŠ¨ç±»åŠ äº†`@EnableRyFeignClients`æ³¨è§£ï¼Œè¿™ä¸ªæ³¨è§£æ˜¯ç”±ryé‡å†™çš„ï¼ŒçœŸæ­£æœ‰ç”¨çš„å…¶å®æ˜¯æ³¨è§£å†…éƒ¨çš„`@EnableFeignClients`æ³¨è§£ï¼š

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/52.png)

è‹¥ä¾é‡å†™è¿™ä¸ªæ³¨è§£çš„ç›®çš„æ˜¯ä¸ºäº†æ‰«æåŒ…ï¼Œ`com.ruoyi`ä¸‹é¢çš„æ‰€æœ‰åŒ…ï¼Œå¦‚æœä¸è¿™ä¹ˆå†™ï¼Œæ‰«æçš„åŒ…å°±æ˜¯å½“å‰åŒ…å’Œå­åŒ…ï¼Œæ¯”å¦‚å½“å‰åŒ…æ˜¯`com.ruoyi.auth`ï¼Œé‚£ä¹ˆåœ¨ ruoyi-api æ¨¡å—å¯èƒ½æ˜¯æ²¡æœ‰`com.ruoyi.auth`è¿™ä¸ªåŒ…çš„ï¼Œå°±ä¼šæ‰«æä¸åˆ°äº†ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/53.png)





ç°åœ¨çœŸæ­£å¼€å§‹è¿œç¨‹è°ƒç”¨äº†`remoteUserService.getUserInfo(username, SecurityConstants.INNER)`,è¿™ä¸ª`SecurityConstants.INNER`åœ¨è‹¥ä¾ä¸­å°±è¡¨ç¤º`inner`ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨æ¨¡å—è°ƒç”¨ã€‚

è€Œ getUserInfo æ–¹æ³•ä¼šä¼ é€’ä¸€ä¸ª usernameï¼ŒåŒæ—¶ä¼šåœ¨è¯·æ±‚å¤´é‡Œé¢æ”¾ä¸€ä¸ª sourceï¼Œè¡¨ç¤ºæºï¼Œå…¶å®ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„`inner`ï¼Œè¡¨ç¤ºè¿™æ˜¯å†…éƒ¨æ¨¡å—çš„è°ƒç”¨ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/54.png)

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/55.png)

åœ¨ruoyi-systemæ¨¡å—ä¸‹çš„`/user/info/{username}`æ–¹æ³•ä¸Šé¢æœ‰æ³¨è§£`@InnerAuth`è¡¨ç¤ºè¿™æ˜¯å¾®æœåŠ¡å†…éƒ¨è°ƒç”¨ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•æ˜¯åˆ‡é¢çš„ï¼š

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/56.png)

è¿™ä¸ªåˆ‡é¢é¦–å…ˆä¼šè·å–è¯·æ±‚å¤´ï¼Œçœ‹æ˜¯å¦æ˜¯å†…éƒ¨è¯·æ±‚ï¼Œå¦‚æœä½ è¯·æ±‚å¤´é‡Œé¢æœ‰`inner`ï¼Œæ‰ä¼šè®©ä½ è°ƒç”¨è¿™ä¸ªæ¥å£ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/57.png)



æ¥ç€å°±æ­£å¼æ‰§è¡Œ`info`æ–¹æ³•äº†ï¼Œé¦–å…ˆæŸ¥è¯¢sql`userService.selectUserByUserName(username)`å¾—åˆ°ç”¨æˆ·ä¿¡æ¯,å¦‚ä¸‹å›¾ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/58.png)

æ¥ç€æ ¹æ®ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢å…¶è§’è‰²ï¼Œ`permissionService.getRolePermission(sysUser)`ï¼Œåœ¨æŸ¥è¯¢è§’è‰²æ—¶ï¼Œåªè¦userId=1ä¸”ä¸ä¸ºç©ºï¼Œå°±ä¼šåŠ ä¸Š`admin`çš„è§’è‰²ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/59.png)

æ¥ç€æŸ¥è¯¢æƒé™ï¼Œ`permissionService.getMenuPermission(sysUser)`ï¼ŒæŸ¥è¯¢åˆ°è¶…çº§ç®¡ç†å‘˜å°±æ˜¯å…¨éƒ¨æƒé™`*.*.*`ï¼Œä¹‹åæ–°åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Œå°†æˆ‘ä»¬æŸ¥è¯¢åˆ°çš„ç”¨æˆ·ã€è§’è‰²ã€æƒé™éƒ½èµ‹å€¼ç»™è¿™ä¸ªç”¨æˆ·ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/60.png)

æ€»ä¹‹æœ€åç»è¿‡ä¸€ç³»åˆ—å°±æ‹¿åˆ°äº†å½“å‰ç”¨æˆ·çš„æ‰€æœ‰ä¿¡æ¯ï¼š

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/61.png)

ä½†æ˜¯è¿™ä¸ªä¿¡æ¯éå¸¸å¤šï¼Œ`data.sysUser`é‡Œé¢æ˜¯æˆ‘ä»¬ç€é‡å…³æ³¨çš„ï¼Œè¿™é‡Œæˆ‘ä»¬æ‹¿åˆ°ååˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰è¢«åˆ é™¤ï¼Œæ˜¯å¦æœ‰è¢«åœç”¨ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/62.png)



æœ€åä¸€æ­¥å°±æ˜¯åˆ¤æ–­ç”¨æˆ·çš„å¯†ç æ˜¯å¦æ­£ç¡®ï¼Œæ ¡éªŒå¯†ç å¦‚ä¸‹ï¼Œé¦–å…ˆåœ¨ redis ä¸­ä¼šå­˜é‡è¯•çš„æ¬¡æ•°ï¼Œå½“è¾“é”™5æ¬¡åï¼Œè´¦æˆ·ä¼šè¢«é”å®š10åˆ†é’Ÿã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/63.png)



è‹¥ä¾è‡ªå·±å†™äº†å¯†ç æ ¡éªŒï¼Œä¹Ÿå°±æ˜¯ matches(user,password) æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨`SecurityUtils`å·¥å…·ç±»è¿›è¡Œæ ¡éªŒã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/64.png)

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/65.png)

æœ€åç™»å½•æˆåŠŸï¼Œè®°å½•ç™»å½•æ—¥å¿—ï¼š

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/66.png)



#### 3ã€ç”Ÿæˆtoken

è¿™ä¸‹æˆ‘ä»¬å°†ç”¨æˆ·çš„ä¿¡æ¯å…¨éƒ¨æ‹¿åˆ°ï¼Œå°±å¯ä»¥ç”ŸæˆTokenäº†ï¼Œç”Ÿæˆåçš„Tokenä½¿ç”¨`R.ok`è¿”å›ç»™å‰ç«¯ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/67.png)

æˆ‘ä»¬è¿›å»çœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•`createToken`çš„ï¼š

1. è·å–uuid
2. è·å–userid
3. è·å–username
4. è®¾ç½®token(å…¶å®æ˜¯è®¾ç½®çš„uuid)
5. è®¾ç½®userid
6. è®¾ç½®username
7. åˆ·æ–°token

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/68.png)

è¿›å»çœ‹ä¸€ä¸‹åˆ·æ–°tokenæ˜¯å¹²å˜›çš„ï¼š

1. è®¾ç½®å½“å‰æ—¶é—´ä¸ºç™»å½•æ—¶é—´
2. è®¾ç½®è¿‡æœŸæ—¶é—´
3. è®¾ç½®å­˜å…¥redisçš„keyé”®ä¸º `login_tokens:uuid`
4. è®¾ç½®çœŸå®çš„tokenï¼Œé”®ä¸º`login_tokens:uuid`ï¼Œå€¼ä¸º`loginUser`å¯¹è±¡

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/69.png)

èµ°å®Œè¿™ä¸€æ­¥åœ¨ redis ä¸­å°±å¯ä»¥çœ‹åˆ°å­˜å…¥çš„KVå•¦ï¼

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/70.png)



#### 4ã€JWTå­˜å‚¨ä¿¡æ¯

åˆ›å»ºä¸€ä¸ªHashMapï¼Œå­˜å…¥ **user_idã€user_keyï¼ˆä¹Ÿå°±æ˜¯uuidï¼‰ã€username**ï¼Œåˆ©ç”¨è¿™ä¸‰ä¸ªä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä¸ªTokenã€‚ä¹‹åTokenè§£æå®Œä¹‹åå°±å¯ä»¥æ‹¿åˆ°uuidï¼Œå°±èƒ½å»redisä¸­å–å‡ºç”¨æˆ·çš„å…¨éƒ¨ä¿¡æ¯äº†ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/71.png)



åˆæ–°å»ºä¸€ä¸ªHashMapï¼Œå°†`access_token:token`ã€`expires_in:720`å­˜å…¥è¿”å›ç»™å‰ç«¯ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹çœŸæ­£çš„tokené•¿ä»€ä¹ˆæ ·å­ï¼šæ˜¯ä¸€é•¿ä¸²å­—ç¬¦ä¸²ï¼Œæ ¹æ®è¿™ä¸€é•¿ä¸²å­—ç¬¦ä¸²å°±å¯ä»¥è§£æå‡º**user_idã€user_keyï¼ˆä¹Ÿå°±æ˜¯uuidï¼‰ã€username**ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/72.png)



### 3.5.4ã€ç™»å½•å‰ç«¯

å‰ç«¯è¯·æ±‚æ•°æ®åæ‹¿åˆ° responseï¼Œé€šè¿‡ response.data å¯ä»¥æ‹¿åˆ°åç«¯ä¼ å›æ¥çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–¹è¿”å›çš„ rspMapã€‚

å‰ç«¯åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œä¸€å¥è¯æ¦‚æ‹¬ï¼š**å°†tokenå’Œè¿‡æœŸæ—¶é—´é€šé€šæ”¾å…¥Cookieå’ŒVuexä¸­**ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/73.png)











ç™»å½•å®Œæˆåï¼Œè·¯ç”±å¸®æˆ‘ä»¬è¿›å…¥åˆ°æˆ‘ä»¬ä¹‹å‰æƒ³è¿›å…¥çš„ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼šæˆ‘ä»¬ç›´æ¥åœ¨æµè§ˆå™¨è¾“å…¥`localhost:/system/user`ï¼Œæœªç™»å½•çš„çŠ¶æ€ä¸‹è‚¯å®šæ˜¯è¿›å…¥äº†ç™»å½•é¡µé¢ï¼Œç™»å½•æˆåŠŸåä¼šå¸®æˆ‘ä»¬å†è·¯ç”±åˆ°`/system/user`é¡µé¢ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/74.png)

ä½†æ˜¯åœ¨å˜è·¯ç”±çš„çŠ¶æ€ä¸‹ï¼Œéƒ½ä¼šè§¦å‘å…¨å±€è·¯ç”±å®ˆå«ï¼š

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/75.png)

ä½†æ˜¯æˆ‘ä»¬å‡å¦‚æ˜¯è¦å»`/index`ï¼Œå°±ä¼šelseçš„ä»£ç ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦æœ‰è§’è‰²ï¼Œè‚¯å®šæ²¡æœ‰è§’è‰²äº†ï¼Œæˆ‘ä»¬åªæ‹¿åˆ°äº†tokenå’Œè¿‡æœŸæ—¶é—´ï¼Œæ€ä¹ˆä¼šæœ‰è§’è‰²å‘¢ï¼Ÿæ‰€ä»¥è¿™ä¸ªæ—¶å€™å‰ç«¯è¿˜éœ€è¦**å†è°ƒç”¨ GetInfo è·å–ç”¨æˆ·ä¿¡æ¯æ¥å£ã€GenerateRoutes è·å–è·¯ç”±æ¥å£**ï¼Œåœ¨`GenerateRoutes ` æ¥å£é‡Œé¢ä¼šè®¾ç½®ä¸€ç³»åˆ—è·¯ç”±ï¼Œç”±æ­¤å°±ä¼šæ¸²æŸ“å‡ºç›¸åº”çš„èœå•ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/76.png)



### 3.5.5ã€è·å–ç”¨æˆ·ä¿¡æ¯å‰ç«¯

åœ¨getTokenæ–¹æ³•ä¸­ï¼Œå…¶å®æ˜¯å»Cookieä¸­ç¡®è®¤å–`Admin-Token:token`çš„é”®å€¼å¯¹

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/77.png)

æ˜¯å› ä¸ºåœ¨æˆ‘ä»¬ç™»å½•æˆåŠŸåï¼Œæµè§ˆå™¨çš„Cookieä¼šå­˜`Admin-Token:token`çš„é”®å€¼å¯¹ï¼š

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/78.png)

æˆ‘ä»¬æ¥ç€æ¥çœ‹ä»£ç `getToken() && !isToken` ï¼Œåœ¨è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯çš„æ¥å£ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰æŒ‡æ˜`headers.isToken`çš„å€¼ï¼Œåˆ™ `config.headers` å°±ä¼šä¸ºç©ºï¼Œ`(config.headers || {}).isToken`çš„å€¼å°±ä¼šå˜æˆundefinedï¼Œåˆ™ isTokenå°±ä¼šæ˜¯ falseï¼Œåˆ™`getToken() && !isToken` å°±ä¼šæ˜¯ trueã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/79.png)

é‚£ä¹ˆå°±ä¼šèµ°`config.headers['Authorization'] = 'Bearer ' + getToken() ` è¿™å¥ä»£ç ï¼Œä¹Ÿå°±æ˜¯ç»™è¯·æ±‚åŠ ä¸€ä¸ªå¤´ï¼š`Authorization:Bearer + token`ï¼Œè¿™æ ·å°±è¾¾æˆäº†æ¯æ¬¡ request å‘è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šé»˜è®¤å¸¦ä¸Šè¿™ä¸ªtokenã€‚

å½“æˆ‘ä»¬éœ€è¦æ¥å£ä¸éœ€è¦æºå¸¦tokençš„æ—¶å€™ï¼Œåªéœ€è¦åŠ ä¸Š`headers: {isToken: false}`



åœ¨è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨`GetInfo`çš„actionsï¼Œå…¶ä¸­ä¼šè°ƒç”¨`getInfo`æ–¹æ³•ï¼Œæ­¤æ–¹æ³•éœ€è¦æºå¸¦Tokenè¿›è¡Œè¯·æ±‚ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/80.png)



### 3.5.6ã€è·å–ç”¨æˆ·ä¿¡æ¯åç«¯

getInfoè¯·æ±‚åœ¨å‘é€åˆ°åç«¯æ—¶ä¼šå…ˆèµ°å…¨å±€è¿‡æ»¤å™¨`AuthFilter`å’Œ`XssFilter`ï¼šæˆ‘ä»¬æ˜¯å¯ä»¥Debugåˆ°getInfoè·å–ç”¨æˆ·ä¿¡æ¯çš„æ¥å£ç¡®å®æºå¸¦äº†tokenï¼Œåœ¨è¯·æ±‚å¤´é‡Œé¢ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/81.png)

è¿™ä¸ªè¿‡æ»¤å™¨å¤§æ¦‚è®²è§£ä¸€ä¸‹æ€è·¯ï¼š

1. é¦–å…ˆè·å–åˆ°è¯·æ±‚çš„ requestï¼Œç„¶åä½¿ç”¨å»ºé€ è€…æ¨¡å¼æ‹·è´ä¸€ä»½ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¸æ±¡æŸ“åŸå§‹è¯·æ±‚çš„ requestï¼ŒæŠŠè¯·æ±‚çš„ Path å–å‡ºï¼Œå°†å…¶æ£€éªŒï¼Œçœ‹æ˜¯ä¸æ˜¯ä¸éœ€è¦éªŒè¯çš„è·¯å¾„ï¼Œæ¯”å¦‚æ³¨å†Œã€ç™»å½•æ˜¯ä¸éœ€è¦authæˆæƒéªŒè¯çš„ï¼Œå¦‚æœç¡®å®æ˜¯ä¸éœ€è¦éªŒè¯çš„è·¯å¾„ï¼Œç›´æ¥æ”¾è¡Œã€‚
2. getInfoæ˜¯éœ€è¦éªŒè¯çš„ï¼Œæ‰€ä»¥ä»è¯·æ±‚çš„ request ä¸­è·å–åˆ° tokenï¼Œå…¶å®ä¹Ÿå°±æ˜¯ä»è¯·æ±‚å¤´ä¸­æ‹¿åˆ°`Authorizationï¼šBearer token`ï¼Œç„¶åé€šè¿‡è£å‰ªæ‰å‰ç¼€ Bearerï¼Œè¿”å›token

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/84.png)

3. åˆ¤æ–­è·å¾—tokenæ˜¯å¦ä¸ºç©ºï¼Œç„¶åä»tokenä¸­è§£å‡º**user_idã€user_keyï¼ˆä¹Ÿå°±æ˜¯uuidï¼‰ã€username**,å› ä¸ºæˆ‘ä»¬ä¹‹å‰ä¹Ÿæ˜¯ç”¨è¿™ä¸‰ä¸ªä¿¡æ¯ç”Ÿæˆçš„tokenã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/85.png)

4. æ‹¿å‡º **user_keyï¼ˆä¹Ÿå°±æ˜¯uuidï¼‰**ï¼Œæ‹¼æ¥ä¸Š`login_tokens:`ï¼Œåœ¨ redis ä¸­æŸ¥è¯¢æ˜¯å¦æœ‰`login_tokens: uuid` å¯¹åº”çš„å€¼ï¼Œè¿™ä¸ªå€¼å°±æ˜¯æˆ‘ä»¬ä¹‹å‰è¯´çš„ï¼Œå½“å‰ç”¨æˆ·çš„æ‰€æœ‰ä¿¡æ¯ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/86.png)

> æ‰€ä»¥ç›¸å½“äºè·å–ç”¨æˆ·ä¿¡æ¯getInfoè¯·æ±‚æ¯æ¬¡éƒ½ä¼šè§£ætokenï¼Œä»redis ä¸­æŸ¥ç”¨æˆ·ä¿¡æ¯ï¼Œèµ°è¿™ä¹ˆä¸ªä½œç”¨çš„è¿‡æ»¤å™¨ã€‚

5. è§£ætokenæˆåŠŸä¹‹åï¼Œè·å–useridã€usernameã€‚æˆ‘ä»¬æŠŠæ‹·è´çš„è¯·æ±‚æ„é€ å™¨æ‹¿å‡ºæ¥ï¼Œè®¾ç½®è¯·æ±‚æ„é€ å™¨çš„è¯·æ±‚å¤´ï¼Œè®¾ç½®ä¸º`userkey:uuid`ã€`userid: 1`ã€`username: "admin"`ï¼Œç›¸å½“äºå­˜å‚¨äº†æ•´ä¸ªç”¨æˆ·ï¼Œæ¯•ç«Ÿå¯ä»¥ä» uuid ä¸­åˆ° redis ä¸­è·å–å…¨éƒ¨ä¿¡æ¯ã€‚

> å®‰å…¨ä¸Šä¸‹æ–‡åœ¨è¿™æ­¥ä¹‹åä¼šä»è¯·æ±‚å¤´ä¸­æ‹¿åˆ°è¿™äº›ä¿¡æ¯è®¾ç½®åˆ°å®‰å…¨ä¸Šä¸‹æ–‡ SecurityContextHolderï¼Œè¿™ä¸ªå®‰å…¨ä¸Šä¸‹æ–‡æ˜¯è‹¥ä¾è‡ªå·±å†™çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºå°±æ˜¯ä¸€ä¸ª ThrealLocalï¼Œçº¿ç¨‹ç§æœ‰ï¼Œåœ¨è¿™ä¸ª ThrealLocal é‡Œé¢æ”¾ç‚¹ä¸œè¥¿ï¼Œåœ¨åé¢å¯ä»¥ä¸€ç›´å–ã€‚ä¹‹åæˆ‘ä»¬å†æ¥è®²è§£è¿™ä¸ª SecurityContextHolder

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/87.png)



6. åœ¨è¯·æ±‚æ„é€ å™¨çš„å¤´é‡Œé¢åˆ é™¤äº†`from-source`å­—æ®µï¼Œå› ä¸ºå†…éƒ¨è°ƒç”¨è¿™ä¸ª`from-source`å­—æ®µæ˜¯ innerï¼Œåˆ é™¤åé˜²æ­¢ä¼ªé€ å†…éƒ¨è°ƒç”¨ã€‚

7. å®Œæˆåèµ°å…¶ä»–çš„è¿‡æ»¤å™¨ï¼Œè¿™é‡Œä¸ä½œåˆ†æ

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/88.png)





> [!note]
>
> è‡³äºä¸éœ€è¦authæˆæƒéªŒè¯çš„è·¯å¾„å…¶å®ä¹Ÿæ˜¯åœ¨nacosä¸­é…ç½®çš„ï¼Œæ˜¯å› ä¸ºè¿™ä¸ª` ignoreWhite.getWhites()`ä¸Šæ–¹æœ‰æ³¨è§£`@ConfigurationProperties(prefix = "security.ignore")`ï¼Œè¯»å–çš„æ˜¯ yml é‡Œé¢çš„è·¯å¾„ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/83.png)

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/82.png)

8. å‘ç”ŸæœåŠ¡é—´çš„è°ƒç”¨ï¼Œé€šè¿‡å®‰å…¨ä¸Šä¸‹æ–‡ SecurityUtils è·å¾—ç”¨æˆ·IDï¼Œè¿›è€ŒæŸ¥è¯¢å‡ºå½“å‰ç”¨æˆ·çš„å…¨éƒ¨ä¿¡æ¯

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/89.png)

9. æ ¹æ®å½“å‰ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢å‡º**ç”¨æˆ·çš„è§’è‰²ã€ç”¨æˆ·çš„æƒé™ï¼Œå°†ç”¨æˆ·è§’è‰²å’Œæƒé™åŒ…è£…ï¼Œè¿åŒç”¨æˆ·ä¸€èµ·è¿”å›ç»™å‰ç«¯**ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/90.png)

è¿™æ ·getInfoæ¥å£å°±è°ƒç”¨å®Œæ¯•äº†ï¼Œæœ€ç»ˆè¿”å›ç»™å‰ç«¯çš„æ•°æ®å¦‚ä¸‹ï¼š

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/97.png)


```json
{
    "msg": "æ“ä½œæˆåŠŸ",
    "code": 200,
    "permissions": [
        "*:*:*"
    ],
    "roles": [
        "admin"
    ],
    "user": {
        "createBy": "admin",
        "createTime": "2024-07-10 00:37:05",
        "updateBy": null,
        "updateTime": null,
        "remark": "ç®¡ç†å‘˜",
        "userId": 1,
        "deptId": 103,
        "userName": "admin",
        "nickName": "è‹¥ä¾",
        "email": "ry@163.com",
        "phonenumber": "15888888888",
        "sex": "1",
        "avatar": "",
        "password": "$2a$10$7JB720yubVSZvUI0rEqK/.VqGOZTH.ulu33dHOiBE8ByOhJIrdAu2",
        "status": "0",
        "delFlag": "0",
        "loginIp": "127.0.0.1",
        "loginDate": "2024-07-20T15:01:58.000+08:00",
        "dept": {
            "createBy": null,
            "createTime": null,
            "updateBy": null,
            "updateTime": null,
            "remark": null,
            "deptId": 103,
            "parentId": 101,
            "ancestors": "0,100,101",
            "deptName": "ç ”å‘éƒ¨é—¨",
            "orderNum": 1,
            "leader": "è‹¥ä¾",
            "phone": null,
            "email": null,
            "status": "0",
            "delFlag": null,
            "parentName": null,
            "children": []
        },
        "roles": [
            {
                "createBy": null,
                "createTime": null,
                "updateBy": null,
                "updateTime": null,
                "remark": null,
                "roleId": 1,
                "roleName": "è¶…çº§ç®¡ç†å‘˜",
                "roleKey": "admin",
                "roleSort": 1,
                "dataScope": "1",
                "menuCheckStrictly": false,
                "deptCheckStrictly": false,
                "status": "0",
                "delFlag": null,
                "flag": false,
                "menuIds": null,
                "deptIds": null,
                "permissions": null,
                "admin": true
            }
        ],
        "roleIds": null,
        "postIds": null,
        "roleId": null,
        "admin": true
    }
}
```



> [!NOTE]
>
> å¥½ç©çš„JSONå·¥å…·æ¨èï¼š[JsonCrack](https://jsoncrack.com/editor)

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/100.png)



### 3.5.7ã€è·å–è·¯ç”±ä¿¡æ¯åç«¯

æˆ‘ä»¬çŸ¥é“åœ¨ç™»å½•çš„æ—¶å€™ä¸å…‰è°ƒç”¨äº†getInfoè·å–ç”¨æˆ·ä¿¡æ¯æ¥å£ï¼Œè¿˜è°ƒç”¨äº† getRouters æ–¹æ³•

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/91.png)

getRouters æ–¹æ³•ä¹Ÿä¼šèµ°å…¨å±€è¿‡æ»¤å™¨ AuthFilterï¼Œä¹‹ååœ¨å‘ç”Ÿå¾®æœåŠ¡è°ƒç”¨ï¼Œæˆ‘ä»¬è¿™é‡Œæ¥è¯´ä¸€ä¸‹å®‰å…¨ä¸Šä¸‹æ–‡`SecurityContextHolder`ï¼Œå…¶å®å®ƒæ˜¯åœ¨æ‹¦æˆªå™¨ HeaderInterceptor é‡Œé¢æ‰§è¡Œçš„ï¼Œé€šä¿—æ¥è¯´ï¼š

- getInfoæ¥å£è°ƒç”¨ - å…¨å±€è¿‡æ»¤å™¨ - å±€éƒ¨è¿‡æ»¤å™¨ - HeaderInterceptor æ‹¦æˆªå™¨
- getRoutersæ¥å£è°ƒç”¨ - å…¨å±€è¿‡æ»¤å™¨ - å±€éƒ¨è¿‡æ»¤å™¨ - HeaderInterceptor æ‹¦æˆªå™¨

æ‹¦æˆªå™¨é‡Œé¢å°†**user_idã€user_keyï¼ˆä¹Ÿå°±æ˜¯uuidï¼‰ã€username**è®¾ç½®è¿›å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ï¼ŒåŒæ—¶å°†å½“å‰ç™»å½•çš„ç”¨æˆ·å¯¹è±¡ä¹Ÿæ”¾è¿›å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/92.png)

> SecurityContextHolder å®‰å…¨ä¸Šä¸‹æ–‡é‡Œé¢å­˜çš„å°±æ˜¯å½“å‰çº¿ç¨‹å˜é‡ä¸­çš„ **ç”¨æˆ·idã€ç”¨æˆ·åç§°ã€Token**ç­‰ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æƒé™è·å–å·¥å…·ç±»ï¼š
>
> - `SecurityUtils.getToken()` ç›´æ¥è·å–åˆ°tokenï¼
> - `SecurityUtils.getUserId()` ç›´æ¥è·å–åˆ°useridï¼
> - `SecurityUtils.getUsername()` ç›´æ¥è·å–åˆ°usernameï¼
> - `SecurityUtils.getLoginUser()` ç›´æ¥è·å–åˆ° loginUserï¼
>
> è¿™é‡Œå¤šè¯´ä¸€ç‚¹ï¼Œ`SecurityContextHolder` å®‰å…¨ä¸Šä¸‹æ–‡å¯ä»¥é€šè¿‡`SecurityUtils`æƒé™è·å–å·¥å…·ç±»è·å–å½“å‰çº¿ç¨‹å˜é‡ä¸­çš„ ç”¨æˆ·idã€ç”¨æˆ·åç§°ã€Tokenç­‰ä¿¡æ¯,å¦‚æœä½ è¦è·å–å¤šä½™çš„ä¿¡æ¯ï¼Œéœ€è¦ä¸¤æ­¥ï¼š
>
> 1. åœ¨`AuthFilter`ä¸­é€šè¿‡è¯·æ±‚å¤´çš„æ–¹æ³•ä¼ å…¥
> 2. åœ¨`HeaderInterceptor`ä¸­è®¾ç½®
>
> ![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/94.png)

> è¿™æ ·æˆ‘ä»¬æ‹¦æˆªå™¨ç®—æ˜¯ç®€å•çœ‹å®Œäº†ï¼Œå¯ä»¥æ¥ç€çœ‹ getRouters æ–¹æ³•äº†

1. é¦–å…ˆè·å– userid
2. æ ¹æ® userid æŸ¥è¯¢èœå•æ ‘

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/93.png)

3. è¿›å…¥`menuService.selectMenuTreeByUserId(userId)`æ–¹æ³•æŸ¥çœ‹,é¦–å…ˆåˆ›å»ºä¸€ä¸ª Listï¼Œè¯¢é—®ä½ æ˜¯å¦æ˜¯ç®¡ç†å‘˜adminï¼Œå¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œåˆ™`menuMapper.selectMenuTreeAll()` ç»™å…¨éƒ¨çš„èœå•ã€‚å¦‚æœä¸æ˜¯ç®¡ç†å‘˜ï¼Œåˆ™` menuMapper.selectMenuTreeByUserId(userId)`

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/95.png)

æœ€åæ ¹æ®`getChildPerms` æ–¹æ³•å°†æŸ¥è¯¢å‡ºçš„ç›®å½•ã€èœå•ç”Ÿæˆä¸€ä¸ªæ ‘ç»“æ„è¿”å›ç»™å‰ç«¯

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/96.png)

è¿™æ ·æœ€ç»ˆ getRouters è¿”å›ç»™å‰ç«¯çš„æ•°æ®å¦‚ä¸‹ï¼š

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/98.png)

```json
{
    "msg": "æ“ä½œæˆåŠŸ",
    "code": 200,
    "data": [
        {
            "name": "System",
            "path": "/system",
            "hidden": false,
            "redirect": "noRedirect",
            "component": "Layout",
            "alwaysShow": true,
            "meta": {
                "title": "ç³»ç»Ÿç®¡ç†",
                "icon": "system",
                "noCache": false,
                "link": null
            },
            "children": [
                {
                    "name": "User",
                    "path": "user",
                    "hidden": false,
                    "component": "system/user/index",
                    "meta": {
                        "title": "ç”¨æˆ·ç®¡ç†",
                        "icon": "user",
                        "noCache": false,
                        "link": null
                    }
                },
                {
                    "name": "Role",
                    "path": "role",
                    "hidden": false,
                    "component": "system/role/index",
                    "meta": {
                        "title": "è§’è‰²ç®¡ç†",
                        "icon": "peoples",
                        "noCache": false,
                        "link": null
                    }
                },
                {
                    "name": "Menu",
                    "path": "menu",
                    "hidden": false,
                    "component": "system/menu/index",
                    "meta": {
                        "title": "èœå•ç®¡ç†",
                        "icon": "tree-table",
                        "noCache": false,
                        "link": null
                    }
                },
                {
                    "name": "Dept",
                    "path": "dept",
                    "hidden": false,
                    "component": "system/dept/index",
                    "meta": {
                        "title": "éƒ¨é—¨ç®¡ç†",
                        "icon": "tree",
                        "noCache": false,
                        "link": null
                    }
                },
                {
                    "name": "Post",
                    "path": "post",
                    "hidden": false,
                    "component": "system/post/index",
                    "meta": {
                        "title": "å²—ä½ç®¡ç†",
                        "icon": "post",
                        "noCache": false,
                        "link": null
                    }
                },
                {
                    "name": "Dict",
                    "path": "dict",
                    "hidden": false,
                    "component": "system/dict/index",
                    "meta": {
                        "title": "å­—å…¸ç®¡ç†",
                        "icon": "dict",
                        "noCache": false,
                        "link": null
                    }
                },
                {
                    "name": "Config",
                    "path": "config",
                    "hidden": false,
                    "component": "system/config/index",
                    "meta": {
                        "title": "å‚æ•°è®¾ç½®",
                        "icon": "edit",
                        "noCache": false,
                        "link": null
                    }
                },
                {
                    "name": "Notice",
                    "path": "notice",
                    "hidden": false,
                    "component": "system/notice/index",
                    "meta": {
                        "title": "é€šçŸ¥å…¬å‘Š",
                        "icon": "message",
                        "noCache": false,
                        "link": null
                    }
                },
                {
                    "name": "Log",
                    "path": "log",
                    "hidden": false,
                    "redirect": "noRedirect",
                    "component": "ParentView",
                    "alwaysShow": true,
                    "meta": {
                        "title": "æ—¥å¿—ç®¡ç†",
                        "icon": "log",
                        "noCache": false,
                        "link": null
                    },
                    "children": [
                        {
                            "name": "Operlog",
                            "path": "operlog",
                            "hidden": false,
                            "component": "system/operlog/index",
                            "meta": {
                                "title": "æ“ä½œæ—¥å¿—",
                                "icon": "form",
                                "noCache": false,
                                "link": null
                            }
                        },
                        {
                            "name": "Logininfor",
                            "path": "logininfor",
                            "hidden": false,
                            "component": "system/logininfor/index",
                            "meta": {
                                "title": "ç™»å½•æ—¥å¿—",
                                "icon": "logininfor",
                                "noCache": false,
                                "link": null
                            }
                        }
                    ]
                }
            ]
        },
        {
            "name": "Monitor",
            "path": "/monitor",
            "hidden": false,
            "redirect": "noRedirect",
            "component": "Layout",
            "alwaysShow": true,
            "meta": {
                "title": "ç³»ç»Ÿç›‘æ§",
                "icon": "monitor",
                "noCache": false,
                "link": null
            },
            "children": [
                {
                    "name": "Online",
                    "path": "online",
                    "hidden": false,
                    "component": "monitor/online/index",
                    "meta": {
                        "title": "åœ¨çº¿ç”¨æˆ·",
                        "icon": "online",
                        "noCache": false,
                        "link": null
                    }
                },
                {
                    "name": "Job",
                    "path": "job",
                    "hidden": false,
                    "component": "monitor/job/index",
                    "meta": {
                        "title": "å®šæ—¶ä»»åŠ¡",
                        "icon": "job",
                        "noCache": false,
                        "link": null
                    }
                },
                {
                    "name": "Http://localhost:8718",
                    "path": "http://localhost:8718",
                    "hidden": false,
                    "component": "Layout",
                    "meta": {
                        "title": "Sentinelæ§åˆ¶å°",
                        "icon": "sentinel",
                        "noCache": false,
                        "link": "http://localhost:8718"
                    }
                },
                {
                    "name": "Http://localhost:8848/nacos",
                    "path": "http://localhost:8848/nacos",
                    "hidden": false,
                    "component": "Layout",
                    "meta": {
                        "title": "Nacosæ§åˆ¶å°",
                        "icon": "nacos",
                        "noCache": false,
                        "link": "http://localhost:8848/nacos"
                    }
                },
                {
                    "name": "Http://localhost:9100/login",
                    "path": "http://localhost:9100/login",
                    "hidden": false,
                    "component": "Layout",
                    "meta": {
                        "title": "Adminæ§åˆ¶å°",
                        "icon": "server",
                        "noCache": false,
                        "link": "http://localhost:9100/login"
                    }
                }
            ]
        },
        {
            "name": "Tool",
            "path": "/tool",
            "hidden": false,
            "redirect": "noRedirect",
            "component": "Layout",
            "alwaysShow": true,
            "meta": {
                "title": "ç³»ç»Ÿå·¥å…·",
                "icon": "tool",
                "noCache": false,
                "link": null
            },
            "children": [
                {
                    "name": "Build",
                    "path": "build",
                    "hidden": false,
                    "component": "tool/build/index",
                    "meta": {
                        "title": "è¡¨å•æ„å»º",
                        "icon": "build",
                        "noCache": false,
                        "link": null
                    }
                },
                {
                    "name": "Gen",
                    "path": "gen",
                    "hidden": false,
                    "component": "tool/gen/index",
                    "meta": {
                        "title": "ä»£ç ç”Ÿæˆ",
                        "icon": "code",
                        "noCache": false,
                        "link": null
                    }
                },
                {
                    "name": "Http://localhost:8080/swagger-ui/index.html",
                    "path": "http://localhost:8080/swagger-ui/index.html",
                    "hidden": false,
                    "component": "Layout",
                    "meta": {
                        "title": "ç³»ç»Ÿæ¥å£",
                        "icon": "swagger",
                        "noCache": false,
                        "link": "http://localhost:8080/swagger-ui/index.html"
                    }
                }
            ]
        },
        {
            "name": "Http://ruoyi.vip",
            "path": "http://ruoyi.vip",
            "hidden": false,
            "component": "Layout",
            "meta": {
                "title": "è‹¥ä¾å®˜ç½‘",
                "icon": "guide",
                "noCache": false,
                "link": "http://ruoyi.vip"
            }
        }
    ]
}
```



![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/99.png)





### 3.5.8ã€è·å–è·¯ç”±ä¿¡æ¯å‰ç«¯

è·¯ç”±åç«¯è¿”å›ç»™å‰ç«¯ï¼Œå‰ç«¯ä½¿ç”¨`JSON.parse`è§£æäº†ä¸¤ä»½æ•°æ®ï¼Œç›¸å½“äºæ‹·è´äº†ä¸€ä»½ã€‚ä¸ºä»€ä¹ˆè¦æ‹·è´ä¸€ä»½å‘¢ï¼Œæ˜¯å› ä¸ºå‰ç«¯æœ‰ä¸¤ç§èœå•å±•ç¤ºæ–¹å¼ï¼šä¾§è¾¹æ å’Œé¡¶æ ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/102.png)

åŠ¨æ€åœ°ä»æœåŠ¡å™¨è·å–è·¯ç”±ä¿¡æ¯ï¼Œå¤„ç†è¿™äº›ä¿¡æ¯ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° Vue Router å’Œ Vuex store ä¸­ï¼Œä»¥ä¾¿åœ¨å‰ç«¯åº”ç”¨ä¸­æ­£ç¡®åœ°æ˜¾ç¤ºå’Œå¯¼èˆªã€‚



















### 3.5.9ã€è·å–ç”¨æˆ·ä¿¡æ¯å‰ç«¯è¡¥å……

æˆ‘ä»¬ä¸Šæ–¹æ‹¿åˆ°äº†åç«¯è¿”å›ç»™å‰ç«¯getInfoæ¥å£çš„æ•°æ®ï¼ŒgetInfoæ¥å£å‰ç«¯æ˜¯æŠŠæ•°æ®æ”¾å…¥äº†Vuexä¸­ï¼š

1. æ‹¿åˆ°åç«¯è¿”å›çš„useræ•°æ®ï¼š`res.user`
2. åˆ¤æ–­ç”¨æˆ·çš„å¤´åƒavatarå­—æ®µæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é»˜è®¤è®¾ç½®`@/assets/images/profile.jpg`
3. å¦‚æœç”¨æˆ·æœ‰è§’è‰²ï¼Œåˆ™æäº¤è§’è‰²ã€æƒé™åˆ°Vuexä¸­ï¼Œå¦‚æœæ²¡æœ‰è§’è‰²ï¼Œåˆ™ç»™ä¸€ä¸ªé»˜è®¤è§’è‰²ã€‚
4. æäº¤useridã€usernameã€avatar åˆ°VueXä¸­

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/101.png)



è‡³æ­¤ï¼Œç™»å½•è¿™å—çš„å‰åç«¯ç®—æ˜¯å·®ä¸å¤šå†™å®Œäº†ï¼ä¸šåŠ¡é€»è¾‘æ˜¯æ¯”è¾ƒå¤æ‚ä¸€ç‚¹ï¼





## 3.6ã€æƒé™

é¦–å…ˆçœ‹ä¸€ä¸‹`sty_menu`èœå•ï¼Œå…¶ä¸­`menu_type`å­—æ®µæ˜¯èœå•ç±»å‹ï¼ˆMç›®å½• Cèœå• FæŒ‰é’®ï¼‰ï¼Œ`perms`å­—æ®µæ˜¯æƒé™æ ‡è¯†ï¼ŒMç›®å½•æ— æƒé™æ ‡è¯†ï¼ŒCèœå•å’ŒFæŒ‰é’®æœ‰æƒé™æ ‡è¯†ï¼Œæ˜¯`xx:xx:xx`

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/103.png)











### 3.6.1ã€å‰ç«¯æƒé™

æˆ‘ä»¬ä¹‹å‰è¯´è¿‡ï¼Œåœ¨ç”¨æˆ·ç™»å½•è¿›ç³»ç»Ÿä¼šè°ƒç”¨`getInfo`è·å¾—ç”¨æˆ·ä¿¡æ¯æ¥å£å’Œ`getRouters`è·å–è·¯ç”±ä¿¡æ¯æ¥å£ã€‚å…¶ä¸­`getInfo`æ¥å£åç«¯ä¼šè¿”å›ç»™å‰ç«¯ä¸€ç³»åˆ—æƒé™å­—ç¬¦ä¸²ï¼šæˆ‘ä»¬ä½¿ç”¨`admin`ç™»å½•çš„æƒé™permissionsæ˜¯`*.*.*`ï¼Œå‡å¦‚æˆ‘ä»¬ç”¨`ry`ç”¨æˆ·ç™»å½•ï¼š

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/104.png)

å‰ç«¯è°ƒç”¨getInfoæ¥å£ï¼Œä¼šè·å¾—ä¸€ç³»åˆ—æƒé™å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå‰ç«¯æƒé™çš„è¡¨ç°ï¼Œå°±æ˜¯`v-hasPermi=['xxx']`ï¼šæ¯”å¦‚`v-hasPermi="['system:user:add']"`ï¼Œå¦‚æœæ­¤ç”¨æˆ·æœ‰`system:user:add`è¿™ä¸ªæƒé™å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè¿™ä¸ª`el-button`æŒ‰é’®å°±å¯ä»¥å±•ç¤ºå‡ºæ¥ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/105.png)

### 3.6.2ã€åç«¯æƒé™

åç«¯çš„æ–¹æ³•ä¸Šæœ‰`@RequiresPermissions("xxx:xxx:xxx")`çš„æ³¨è§£ï¼Œæœ‰äº†è¿™ä¸ªæ³¨è§£ï¼Œè¿™ä¸ªæ–¹æ³•å°±ä¼šè¢«AOPåˆ‡å…¥ï¼Œåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦å…·æœ‰`xxx:xxx:xxx`è¿™ä¸ªæƒé™ï¼Œå¦‚æœæœ‰è¿™ä¸ªæƒé™ï¼Œæ‰å¯ä»¥è¢«è°ƒç”¨è¿™ä¸ªæ¥å£ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/106.png)



### 3.6.3ã€æƒé™æ€»ç»“

1. å®šä¹‰æƒé™

   åœ¨Webç«¯çš„**èœå•ç®¡ç†**å»å®šä¹‰æƒé™ï¼Œä¸»è¦æ˜¯ç»™**èœå•å’ŒæŒ‰é’®æƒé™å­—ç¬¦**ã€‚ä¼šè¢«æ·»åŠ åˆ°æ•°æ®åº“ä¸­ï¼Œåœ¨ç”¨æˆ·ç™»å½• getInfo å’Œ getRouters çš„æ—¶å€™ï¼Œä¼šæ‹¿åˆ°è¿™ä¸ªæƒé™å­—ç¬¦ã€‚

![](è‹¥ä¾å¾®æœåŠ¡(ä¸€).assets/107.png)

2. getInfo æŸ¥å‡ºæƒé™ï¼Œå‰ç«¯VueXä¸­ä¹Ÿå­˜ç€ç”¨æˆ·çš„æƒé™ï¼Œæ ¹æ®æƒé™å±•ç¤ºç›®å½•å’Œèœå•
3. getInfo æŸ¥è¯¢å‡ºçš„æƒé™åœ¨åç«¯çš„ Redis ä¸­çš„ LoginUser ä¸­å­˜å‚¨ä¸€ä»½ï¼Œç”¨äºAOPåˆ‡å…¥ï¼Œæ ¹æ®åç«¯æ–¹æ³•ä¸Šçš„æ³¨è§£`@RequiresPermissions` å®Œæˆæƒé™çš„æ ¡éªŒã€‚



























































































